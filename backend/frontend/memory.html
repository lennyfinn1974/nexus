<!DOCTYPE html>
<html>
<head>
    <title>Nexus Memory Dashboard</title>
    <style>
        body { font-family: system-ui; margin: 20px; background: #f5f7fa; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); }
        .tabs { display: flex; background: white; border-radius: 8px 8px 0 0; }
        .tab { padding: 15px 25px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom-color: #3498db; background: #ecf4ff; }
        .tab-content { display: none; background: white; padding: 30px; border-radius: 0 0 8px 8px; }
        .tab-content.active { display: block; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; margin: 5px; background: #3498db; color: white; }
        .metric { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .metric-value { font-weight: 600; color: #2980b9; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .status-active { color: #27ae60; font-weight: 600; }
        .status-inactive { color: #e74c3c; font-weight: 600; }
        .data-item { padding: 12px; margin: 8px 0; border: 1px solid #e2e8f0; border-radius: 6px; background: #f7fafc; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Nexus Memory Dashboard</h1>
            <p>Monitor your AI\'s learned preferences, patterns, and projects.</p>
            <div>
                <span id="status" class="status-inactive">Connecting...</span>
                <button onclick="refresh()" class="btn">üîÑ Refresh</button>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>üìä Memory Overview</h3>
                <div id="overview"><div class="loading">Loading...</div></div>
            </div>
            <div class="card">
                <h3>üéØ Quick Actions</h3>
                <button class="btn" onclick="exportData()">üíæ Export Memory</button>
                <button class="btn" onclick="refresh()">üîÑ Refresh All</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab(\'preferences\')">üéõÔ∏è Preferences</div>
            <div class="tab" onclick="showTab(\'patterns\')">üîÑ Patterns</div>
            <div class="tab" onclick="showTab(\'projects\')">üìÇ Projects</div>
            <div class="tab" onclick="showTab(\'sessions\')">üìà Sessions</div>
        </div>

        <div class="card" style="margin-top: 0;">
            <div id="preferences-tab" class="tab-content active">
                <h3>Learned Preferences</h3>
                <div id="preferences-list"><div class="loading">Loading...</div></div>
            </div>
            <div id="patterns-tab" class="tab-content">
                <h3>Interaction Patterns</h3>
                <div id="patterns-list"><div class="loading">No patterns yet</div></div>
            </div>
            <div id="projects-tab" class="tab-content">
                <h3>Active Projects</h3>
                <div id="projects-list"><div class="loading">No projects yet</div></div>
            </div>
            <div id="sessions-tab" class="tab-content">
                <h3>Session History</h3>
                <div id="sessions-list"><div class="loading">No sessions yet</div></div>
            </div>
        </div>
    </div>

    <script>
        async function apiCall(endpoint) {
            try {
                const response = await fetch(`/admin/memory/api${endpoint}`);
                return await response.json();
            } catch (error) {
                console.error(error);
                return { error: error.message };
            }
        }

        async function loadStatus() {
            const status = document.getElementById("status");
            const data = await apiCall("/overview");
            if (data.error) {
                status.textContent = "‚ùå " + data.error;
                status.className = "status-inactive";
            } else {
                status.textContent = "‚úÖ Memory Active";
                status.className = "status-active";
            }
        }

        async function loadOverview() {
            const container = document.getElementById("overview");
            const data = await apiCall("/overview");
            if (data.analytics) {
                const a = data.analytics;
                container.innerHTML = `
                    <div class="metric"><span>Preferences</span><span class="metric-value">${a.preferences_count || 0}</span></div>
                    <div class="metric"><span>Patterns</span><span class="metric-value">${a.patterns_count || 0}</span></div>
                    <div class="metric"><span>Projects</span><span class="metric-value">${a.projects_count || 0}</span></div>
                `;
            } else {
                container.innerHTML = "<div class=\\"loading\\">Memory not available</div>";
            }
        }

        async function loadPreferences() {
            const container = document.getElementById("preferences-list");
            const data = await apiCall("/preferences");
            if (data.preferences) {
                let html = "";
                for (const [category, prefs] of Object.entries(data.preferences)) {
                    if (Object.keys(prefs).length > 0) {
                        html += `<h4>${category.toUpperCase()}</h4>`;
                        for (const [key, pref] of Object.entries(prefs)) {
                            html += `<div class="data-item"><strong>${key}:</strong> ${JSON.stringify(pref.value)}</div>`;
                        }
                    }
                }
                container.innerHTML = html || "<div class=\\"loading\\">No preferences learned yet</div>";
            } else {
                container.innerHTML = "<div class=\\"loading\\">Failed to load preferences</div>";
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
            document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));
            
            // Show selected tab
            event.target.classList.add("active");
            document.getElementById(tabName + "-tab").classList.add("active");
            
            // Load data for the tab
            if (tabName === "preferences") loadPreferences();
        }

        async function exportData() {
            const data = await apiCall("/export");
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "nexus-memory-export.json";
            a.click();
        }

        function refresh() {
            loadStatus();
            loadOverview();
            loadPreferences();
        }

        // Load on page start
        document.addEventListener("DOMContentLoaded", function() {
            refresh();
            setInterval(loadStatus, 30000); // Update status every 30s
        });
    </script>
</body>
</html>