name: Nexus CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  ADMIN_API_KEY: "ci-test-admin-key"
  ALLOWED_ORIGINS: "http://testserver"

jobs:
  # ── Lint ──
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install ruff black mypy

      - name: Check formatting (black)
        run: black --check --diff backend/ tests/

      - name: Lint (ruff)
        run: ruff check backend/ tests/

      - name: Type check (mypy)
        run: mypy backend/ --ignore-missing-imports --no-error-summary || true

  # ── Security Scan ──
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install bandit
        run: pip install bandit

      - name: Run bandit security scan
        run: bandit -r backend/ -ll -ii --exclude backend/test_*.py -f json -o bandit-report.json || true

      - name: Check for high severity issues
        run: |
          python -c "
          import json, sys
          with open('bandit-report.json') as f:
              report = json.load(f)
          high = [r for r in report.get('results', []) if r['issue_severity'] == 'HIGH']
          if high:
              for h in high:
                  print(f\"HIGH: {h['filename']}:{h['line_number']} - {h['issue_text']}\")
              sys.exit(1)
          print('No high-severity issues found')
          "

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json

  # ── Test ──
  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run tests with coverage
        run: |
          cd ${{ github.workspace }}
          PYTHONPATH=backend pytest tests/ \
            --cov=backend \
            --cov-report=xml:coverage.xml \
            --cov-report=html:htmlcov \
            --cov-report=term-missing \
            -x \
            --timeout=60 \
            -m "not slow and not benchmark"
        env:
          ADMIN_API_KEY: ci-test-admin-key
          ALLOWED_ORIGINS: http://testserver

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/

      - name: Check coverage threshold
        run: |
          pip install coverage
          coverage report --fail-under=80 || echo "::warning::Coverage below 80% threshold"

  # ── Build Docker Image ──
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, security]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: nexus:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image starts
        run: |
          docker build -t nexus:test .
          docker run -d --name nexus-test \
            -e ADMIN_API_KEY=test-key \
            -e HOST=0.0.0.0 \
            -e PORT=8080 \
            -p 8080:8080 \
            nexus:test
          # Wait for startup
          sleep 10
          # Health check
          curl -sf http://localhost:8080/api/status || (docker logs nexus-test && exit 1)
          docker stop nexus-test
          docker rm nexus-test
