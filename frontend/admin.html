<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nexus Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a0a0f; --bg-secondary: #12121a; --bg-tertiary: #1a1a26;
    --bg-hover: #222233; --text-primary: #e8e8f0; --text-secondary: #8888a8;
    --text-muted: #555570; --accent: #6c5ce7; --accent-dim: #4a3db5;
    --accent-glow: rgba(108,92,231,0.15); --success: #00d2a0; --warning: #ffa94d;
    --error: #ff6b6b; --border: #2a2a3a; --border-light: #333346;
    --radius: 12px; --radius-sm: 8px;
    --font-sans: 'DM Sans', -apple-system, sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: var(--font-sans); background: var(--bg-primary); color: var(--text-primary); height: 100vh; display: flex; overflow: hidden; }

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  .sidebar { width: 220px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
  .sidebar-header { padding: 16px 16px 12px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
  .logo { width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent), #a78bfa); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; color: #fff; }
  .sidebar-header h1 { font-size: 15px; font-weight: 700; }
  .sidebar-header .version { font-size: 10px; color: var(--text-muted); font-family: var(--font-mono); }

  .nav { flex: 1; padding: 8px; overflow-y: auto; }
  .nav-section { padding: 12px 8px 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); }
  .nav-btn { width: 100%; padding: 9px 12px; background: none; border: none; color: var(--text-secondary); font-family: var(--font-sans); font-size: 13px; text-align: left; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 9px; transition: all 0.15s; margin-bottom: 2px; }
  .nav-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
  .nav-btn.active { background: var(--accent-glow); color: var(--accent); }
  .nav-btn svg { width: 15px; height: 15px; flex-shrink: 0; }

  .back-btn { padding: 12px 16px; border-top: 1px solid var(--border); }
  .back-btn a { color: var(--text-muted); font-size: 12px; text-decoration: none; display: flex; align-items: center; gap: 6px; }
  .back-btn a:hover { color: var(--accent); }

  /* ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ */
  .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .page-header { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
  .page-header h2 { font-size: 16px; font-weight: 600; }
  .page-content { flex: 1; overflow-y: auto; padding: 24px; }
  .page-content::-webkit-scrollbar { width: 6px; }
  .page-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* ‚îÄ‚îÄ Page sections (only active one shown) ‚îÄ‚îÄ */
  .page { display: none; }
  .page.active { display: block; }

  .settings-group { display: flex; flex-direction: column; gap: 14px; }
  .setting-field label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; }
  .setting-field input[type="text"],
  .setting-field input[type="password"],
  .setting-field input[type="number"],
  .setting-field select {
    width: 100%; padding: 8px 10px; background: var(--bg-primary); border: 1px solid var(--border);
    border-radius: 6px; color: var(--text-primary); font-family: var(--font-mono); font-size: 12px;
  }
  .setting-field input:focus, .setting-field select:focus { outline: none; border-color: var(--accent); }
  .setting-field input[type="range"] { width: 100%; accent-color: var(--accent); }

  /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
  .card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
  .card-header { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }

  /* ‚îÄ‚îÄ Form Fields ‚îÄ‚îÄ */
  .field { margin-bottom: 16px; }
  .field label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 3px; }
  .field-desc { font-size: 10px; color: var(--text-muted); margin-bottom: 6px; }
  .field input[type="text"], .field input[type="password"], .field input[type="number"],
  .field select, .field textarea {
    width: 100%; padding: 9px 11px; background: var(--bg-tertiary); border: 1px solid var(--border);
    border-radius: 6px; color: var(--text-primary); font-family: var(--font-mono); font-size: 12px;
    outline: none; transition: border-color 0.15s;
  }
  .field input:focus, .field select:focus, .field textarea:focus { border-color: var(--accent); }
  .field textarea { min-height: 80px; resize: vertical; font-family: var(--font-sans); }
  .field input[type="range"] { width: 100%; accent-color: var(--accent); }
  .range-display { text-align: center; font-size: 24px; font-weight: 700; color: var(--accent); font-family: var(--font-mono); margin: 4px 0; }
  .range-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); font-family: var(--font-mono); }

  .field-row { display: flex; gap: 8px; align-items: flex-end; }
  .field-row .field { flex: 1; margin-bottom: 0; }

  .pw-wrapper { position: relative; }
  .pw-toggle { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 11px; font-family: var(--font-mono); }
  .pw-toggle:hover { color: var(--accent); }

  /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
  .btn { padding: 8px 16px; border: none; border-radius: 6px; font-family: var(--font-sans); font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.15s; display: inline-flex; align-items: center; gap: 6px; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: var(--accent-dim); }
  .btn-secondary { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--bg-hover); color: var(--text-primary); }
  .btn-success { background: var(--success); color: #000; }
  .btn-danger { background: var(--error); color: #fff; opacity: 0.85; }
  .btn-danger:hover { opacity: 1; }
  .btn-sm { padding: 5px 10px; font-size: 11px; }
  .btn-row { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ‚îÄ‚îÄ Status Badges ‚îÄ‚îÄ */
  .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-family: var(--font-mono); font-weight: 600; }
  .badge-ok { background: rgba(0,210,160,0.15); color: var(--success); }
  .badge-err { background: rgba(255,107,107,0.15); color: var(--error); }
  .badge-warn { background: rgba(255,169,77,0.15); color: var(--warning); }
  .badge-off { background: var(--bg-hover); color: var(--text-muted); }

  /* ‚îÄ‚îÄ Plugin Cards ‚îÄ‚îÄ */
  .plugin-card { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; margin-bottom: 10px; }
  .plugin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
  .plugin-header h4 { font-size: 13px; font-weight: 600; }
  .plugin-desc { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
  .plugin-meta { font-size: 10px; color: var(--text-muted); font-family: var(--font-mono); }
  .plugin-tools { margin-top: 8px; padding: 8px; background: var(--bg-primary); border-radius: 6px; font-size: 11px; font-family: var(--font-mono); color: var(--text-muted); max-height: 120px; overflow-y: auto; }
  .plugin-tools div { padding: 2px 0; }

  /* ‚îÄ‚îÄ Log Viewer ‚îÄ‚îÄ */
  .log-viewer { background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; height: 400px; overflow-y: auto; font-family: var(--font-mono); font-size: 11px; padding: 8px; }
  .log-viewer::-webkit-scrollbar { width: 4px; }
  .log-viewer::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .log-entry { padding: 2px 0; line-height: 1.5; white-space: pre-wrap; word-break: break-all; }
  .log-entry .ts { color: var(--text-muted); }
  .log-entry .lvl-INFO { color: var(--success); }
  .log-entry .lvl-WARNING { color: var(--warning); }
  .log-entry .lvl-ERROR { color: var(--error); }
  .log-entry .lvl-DEBUG { color: var(--text-muted); }

  /* ‚îÄ‚îÄ Data table ‚îÄ‚îÄ */
  .data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .data-table th { text-align: left; padding: 8px; border-bottom: 1px solid var(--border); font-size: 10px; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); }
  .data-table td { padding: 8px; border-bottom: 1px solid var(--border); }
  .data-table tr:hover td { background: var(--bg-hover); }

  /* ‚îÄ‚îÄ Stat boxes ‚îÄ‚îÄ */
  .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .stat-box { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; }
  .stat-box .stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); margin-bottom: 4px; }
  .stat-box .stat-value { font-size: 22px; font-weight: 700; font-family: var(--font-mono); }
  .stat-box .stat-sub { font-size: 10px; color: var(--text-muted); margin-top: 2px; }

  /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
  .toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; border-radius: 8px; font-size: 13px; font-weight: 500; z-index: 200; animation: toastIn 0.3s ease; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
  .toast.success { background: var(--success); color: #000; }
  .toast.error { background: var(--error); color: #fff; }
  .toast.info { background: var(--accent); color: #fff; }
  @keyframes toastIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

  /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
  @media (max-width: 768px) { .sidebar { width: 0; overflow: hidden; } .stats { grid-template-columns: 1fr 1fr; } }
</style>
</head>
<body>

<!-- Sidebar Navigation -->
<aside class="sidebar">
  <div class="sidebar-header">
    <div class="logo">N</div>
    <div><h1>Nexus</h1><span class="version">v2.0 Admin</span></div>
  </div>
  <div class="nav">
    <div class="nav-section">Overview</div>
    <button class="nav-btn active" onclick="showPage('dashboard', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      Dashboard
    </button>

    <div class="nav-section">Configure</div>
    <button class="nav-btn" onclick="showPage('models', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
      Models
    </button>
    <button class="nav-btn" onclick="showPage('settings', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      Settings
    </button>
    <button class="nav-btn" onclick="showPage('plugins', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg>
      Plugins
    </button>
    <button class="nav-btn" onclick="showPage('persona', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      Persona
    </button>

    <div class="nav-section" id="navAuthSection" style="display:none">Security</div>
    <button class="nav-btn" id="navUsers" onclick="showPage('users', this)" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
      Users
    </button>
    <button class="nav-btn" id="navWhitelist" onclick="showPage('whitelist', this)" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>
      Whitelist
    </button>
    <button class="nav-btn" id="navIpSecurity" onclick="showPage('ipsecurity', this)" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      IP Security
    </button>
    <button class="nav-btn" id="navAudit" onclick="showPage('audit', this)" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      Auth Audit
    </button>

    <div class="nav-section">Monitor</div>
    <button class="nav-btn" onclick="showPage('conversations', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      Conversations
    </button>
    <button class="nav-btn" onclick="showPage('logs', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Logs
    </button>
    <button class="nav-btn" onclick="showPage('system', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      System
    </button>
  </div>
  <div class="back-btn"><a href="/">‚Üê Back to Chat</a></div>
</aside>

<!-- Main Content -->
<main class="main">
  <div class="page-header">
    <h2 id="pageTitle">Dashboard</h2>
    <div class="btn-row" id="pageActions"></div>
  </div>
  <div class="page-content">

    <!-- ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê -->
    <div class="page active" id="pg-dashboard">
      <div class="stats" id="dashStats"></div>
      <div class="card"><div class="card-header">Recent Activity</div><div id="dashActivity"><p style="color:var(--text-muted)">Loading...</p></div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê MODELS ‚ïê‚ïê‚ïê -->
    <div class="page" id="pg-models">
      <div class="stats-grid" id="modelStatus" style="margin-bottom:20px"></div>

      <div class="card">
        <div class="card-header">Claude (Cloud)</div>
        <div class="settings-group">
          <div class="setting-field">
            <label>Model</label>
            <select id="mdl_claude_model" data-mdl="CLAUDE_MODEL">
              <option value="claude-sonnet-4-20250514">claude-sonnet-4-20250514</option>
              <option value="claude-haiku-4-20250414">claude-haiku-4-20250414</option>
              <option value="claude-opus-4-20250514">claude-opus-4-20250514</option>
            </select>
          </div>
          <div class="setting-field">
            <label>API Key</label>
            <input type="password" id="mdl_anthropic_key" data-mdl="ANTHROPIC_API_KEY" placeholder="sk-ant-...">
          </div>
          <div class="btn-row">
            <button class="btn btn-secondary btn-sm" onclick="testModel('claude')">üß™ Test Claude</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Ollama (Local)</div>
        <div class="settings-group">
          <div class="setting-field">
            <label>Server URL</label>
            <input type="text" id="mdl_ollama_url" data-mdl="OLLAMA_BASE_URL" placeholder="http://localhost:11434">
          </div>
          <div class="setting-field">
            <label>Model</label>
            <div style="display:flex;gap:8px;align-items:center">
              <input type="text" id="mdl_ollama_model" data-mdl="OLLAMA_MODEL" placeholder="llama3.1" style="flex:1">
              <button class="btn btn-secondary btn-sm" onclick="fetchOllamaModels()" style="white-space:nowrap">üìã Browse</button>
            </div>
            <div id="ollamaModelList" style="margin-top:6px"></div>
          </div>
          <div class="btn-row">
            <button class="btn btn-secondary btn-sm" onclick="testModel('ollama')">üß™ Test Ollama</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Routing</div>
        <div class="settings-group">
          <div class="setting-field">
            <label>Complexity Threshold</label>
            <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Messages scoring above this go to Claude, below to Ollama. 0 = always Claude, 100 = always local.</p>
            <div style="display:flex;align-items:center;gap:12px">
              <input type="range" id="mdl_threshold" data-mdl="COMPLEXITY_THRESHOLD" min="0" max="100" style="flex:1">
              <span id="mdl_threshold_val" style="font-family:var(--font-mono);font-size:14px;font-weight:600;min-width:30px;text-align:center">60</span>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);margin-top:4px">
              <span>‚Üê Always Claude</span>
              <span>Always Local ‚Üí</span>
            </div>
          </div>
        </div>
      </div>

      <div class="btn-row" style="margin-top:16px">
        <button class="btn btn-primary" onclick="saveModelSettings()">üíæ Save & Apply</button>
        <button class="btn btn-danger" onclick="restartServer()">‚ö° Restart Server</button>
      </div>
      <p style="font-size:11px;color:var(--text-muted);margin-top:8px">Model changes take effect immediately ‚Äî restart only needed if connections are stale.</p>
    </div>

    <!-- ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê -->
    <div class="page" id="pg-settings">
      <div id="settingsContainer"><p style="color:var(--text-muted)">Loading settings...</p></div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="saveSettings()">üíæ Save All Settings</button>
        <button class="btn btn-secondary" onclick="loadSettings()">‚Üª Reload</button>
        <button class="btn btn-danger" onclick="restartServer()">‚ö° Restart Server</button>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PLUGINS ‚ïê‚ïê‚ïê -->
    <div class="page" id="pg-plugins">
      <div class="btn-row" style="margin-bottom:16px">
        <button class="btn btn-primary" onclick="reloadAllPlugins()">‚Üª Reload All Plugins</button>
        <button class="btn btn-danger" onclick="restartServer()">‚ö° Restart Server</button>
      </div>
      <div id="pluginsContainer"><p style="color:var(--text-muted)">Loading plugins...</p></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PERSONA ‚ïê‚ïê‚ïê -->
    <div class="page" id="pg-persona">
      <div class="card">
        <div class="card-header">Agent Identity</div>
        <div class="field"><label>Agent Name</label><div class="field-desc">The name your agent uses to identify itself</div><input type="text" id="pName" data-key="AGENT_NAME" value="Nexus"></div>
        <div class="field"><label>Response Tone</label><div class="field-desc">Overall tone for agent responses</div>
          <select id="pTone" data-key="PERSONA_TONE"><option value="professional">Professional</option><option value="balanced" selected>Balanced</option><option value="casual">Casual</option><option value="technical">Technical</option></select>
        </div>
        <div class="field"><label>Custom Instructions</label><div class="field-desc">Extra behaviour instructions appended to the system prompt</div>
          <textarea id="pInstructions" data-key="CUSTOM_SYSTEM_PROMPT" rows="5" placeholder="e.g. Always respond in British English. You work for Acme Corp."></textarea>
        </div>
        <div class="btn-row"><button class="btn btn-primary" onclick="savePersona()">üíæ Save Persona</button></div>
      </div>
      <div class="card"><div class="card-header">System Prompt Preview</div><pre id="promptPreview" style="font-size:11px;color:var(--text-muted);white-space:pre-wrap;max-height:300px;overflow-y:auto;"></pre></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CONVERSATIONS ‚ïê‚ïê‚ïê -->
    <div class="page" id="pg-conversations">
      <div class="btn-row" style="margin-bottom:16px">
        <button class="btn btn-danger btn-sm" onclick="clearAllConversations()">üóëÔ∏è Clear All History</button>
      </div>
      <div id="convsContainer"><p style="color:var(--text-muted)">Loading...</p></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê LOGS ‚ïê‚ïê‚ïê -->
    <div class="page" id="pg-logs">
      <div style="margin-bottom:12px; display:flex; gap:8px; align-items:center;">
        <select id="logFilter" onchange="filterLogs()" style="padding:6px 10px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px;">
          <option value="all">All Levels</option><option value="ERROR">Errors</option><option value="WARNING">Warnings</option><option value="INFO">Info</option>
        </select>
        <button class="btn btn-secondary btn-sm" onclick="clearLogViewer()">Clear</button>
        <span style="font-size:10px;color:var(--text-muted);margin-left:auto;" id="logStatus">Connecting...</span>
      </div>
      <div class="log-viewer" id="logViewer"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê USERS ‚ïê‚ïê‚ïê -->
    <div class="page" id="pg-users">
      <div id="usersContainer"><p style="color:var(--text-muted)">Loading users...</p></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê WHITELIST ‚ïê‚ïê‚ïê -->
    <div class="page" id="pg-whitelist">
      <div class="card">
        <div class="card-header">Add Email to Whitelist</div>
        <div class="field-row">
          <div class="field" style="margin:0"><input type="text" id="wlEmail" placeholder="user@example.com"></div>
          <button class="btn btn-primary btn-sm" onclick="addToWhitelist()">Add</button>
        </div>
      </div>
      <div id="whitelistContainer"><p style="color:var(--text-muted)">Loading whitelist...</p></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê IP SECURITY ‚ïê‚ïê‚ïê -->
    <div class="page" id="pg-ipsecurity">
      <div class="card">
        <div class="card-header">Block an IP Address</div>
        <div class="field-row">
          <div class="field" style="margin:0"><input type="text" id="blockIp" placeholder="192.168.1.1"></div>
          <div class="field" style="margin:0"><input type="text" id="blockReason" placeholder="Reason (optional)"></div>
          <button class="btn btn-danger btn-sm" onclick="blockIp()">Block</button>
        </div>
      </div>
      <div id="ipContainer"><p style="color:var(--text-muted)">Loading blocked IPs...</p></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê AUTH AUDIT ‚ïê‚ïê‚ïê -->
    <div class="page" id="pg-audit">
      <div style="margin-bottom:12px; display:flex; gap:8px; align-items:center;">
        <select id="auditFilter" onchange="loadAuditLog()" style="padding:6px 10px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px;">
          <option value="">All Events</option>
          <option value="login_success">Login Success</option>
          <option value="login_failed">Login Failed</option>
          <option value="logout">Logout</option>
          <option value="token_refresh">Token Refresh</option>
          <option value="token_revoked">Token Revoked</option>
          <option value="user_role_change">Role Change</option>
          <option value="ip_blocked">IP Blocked</option>
          <option value="ip_unblocked">IP Unblocked</option>
        </select>
        <button class="btn btn-secondary btn-sm" onclick="loadAuditLog()">Refresh</button>
      </div>
      <div id="auditContainer"><p style="color:var(--text-muted)">Loading audit log...</p></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SYSTEM ‚ïê‚ïê‚ïê -->
    <div class="page" id="pg-system">
      <div class="card"><div class="card-header">System Information</div><div id="sysInfo" style="font-size:12px;font-family:var(--font-mono);color:var(--text-secondary);line-height:2;"></div></div>
      <div class="card">
        <div class="card-header">Usage Statistics</div>
        <div id="usageStats"><p style="color:var(--text-muted)">Loading...</p></div>
      </div>
      <div class="card">
        <div class="card-header">Server Controls</div>
        <div class="btn-row" style="margin-top:0">
          <button class="btn btn-danger" onclick="restartServer()">‚ö° Restart Server</button>
          <button class="btn btn-secondary" onclick="reloadAllPlugins()">‚Üª Reload All Plugins</button>
        </div>
        <p style="font-size:11px;color:var(--text-muted);margin-top:10px">Restart replaces the server process. The page will reconnect automatically once it's back.</p>
      </div>
      <div class="card">
        <div class="card-header">Backups</div>
        <div class="btn-row" style="margin-top:0;margin-bottom:12px"><button class="btn btn-secondary" onclick="createBackup()">üì¶ Create Backup Now</button></div>
        <div id="backupsList"></div>
      </div>
    </div>

  </div>
</main>

<script>
  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
  function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
  function toast(msg, type) { const t = document.createElement('div'); t.className = `toast ${type||'info'}`; t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.remove(), 3500); }
  async function api(path, opts) {
    const resp = await fetch('/api/admin' + path, opts);
    if (resp.status === 401) {
      // Try refresh
      const refreshResp = await fetch('/api/auth/refresh', { method: 'POST' });
      if (!refreshResp.ok) { window.location.href = '/'; return; }
      // Retry original request
      const retry = await fetch('/api/admin' + path, opts);
      if (!retry.ok) throw new Error(`HTTP ${retry.status}`);
      return retry.json();
    }
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    return resp.json();
  }

  // ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
  function showPage(name, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('pg-' + name).classList.add('active');
    if (btn) btn.classList.add('active');
    document.getElementById('pageTitle').textContent = {
      dashboard:'Dashboard', models:'Models', settings:'Settings', plugins:'Plugins', persona:'Persona',
      conversations:'Conversations', logs:'Logs', system:'System',
      users:'Users', whitelist:'Whitelist', ipsecurity:'IP Security', audit:'Auth Audit'
    }[name] || name;
    loaders[name]?.();
  }

  const loaders = {
    dashboard: loadDashboard,
    models: loadModels,
    settings: loadSettings,
    plugins: loadPlugins,
    persona: loadPersona,
    conversations: loadConversations,
    logs: initLogs,
    system: loadSystem,
    users: loadUsers,
    whitelist: loadWhitelist,
    ipsecurity: loadBlockedIps,
    audit: loadAuditLog,
  };

  // ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
  async function loadDashboard() {
    try {
      const [status, usage] = await Promise.all([fetch('/api/status').then(r=>r.json()), api('/usage')]);
      let totalTokens = 0; let totalMessages = 0;
      (usage.totals||[]).forEach(t => { totalTokens += (t.total_tokens_in||0) + (t.total_tokens_out||0); totalMessages += t.message_count||0; });
      document.getElementById('dashStats').innerHTML = `
        <div class="stat-box"><div class="stat-label">Ollama</div><div class="stat-value">${status.models.ollama_available ? '<span style="color:var(--success)">Online</span>' : '<span style="color:var(--error)">Offline</span>'}</div><div class="stat-sub">${esc(status.models.ollama_model||'‚Äî')}</div></div>
        <div class="stat-box"><div class="stat-label">Claude</div><div class="stat-value">${status.models.claude_available ? '<span style="color:var(--success)">Online</span>' : '<span style="color:var(--error)">Offline</span>'}</div><div class="stat-sub">${esc(status.models.claude_model||'‚Äî')}</div></div>
        <div class="stat-box"><div class="stat-label">Plugins</div><div class="stat-value">${Object.keys(status.plugins||{}).length}</div><div class="stat-sub">active</div></div>
        <div class="stat-box"><div class="stat-label">Skills</div><div class="stat-value">${status.skills_count||0}</div><div class="stat-sub">learned</div></div>
        <div class="stat-box"><div class="stat-label">Messages</div><div class="stat-value">${totalMessages.toLocaleString()}</div><div class="stat-sub">total</div></div>
        <div class="stat-box"><div class="stat-label">Tokens</div><div class="stat-value">${totalTokens.toLocaleString()}</div><div class="stat-sub">total used</div></div>
      `;
      const convs = await api('/conversations');
      const recent = (convs||[]).slice(0,5);
      document.getElementById('dashActivity').innerHTML = recent.length
        ? recent.map(c => `<div style="padding:6px 0;border-bottom:1px solid var(--border);font-size:12px;display:flex;justify-content:space-between"><span>${esc(c.title||'Untitled')}</span><span style="color:var(--text-muted);font-family:var(--font-mono);font-size:10px">${c.message_count||0} msgs</span></div>`).join('')
        : '<p style="color:var(--text-muted);font-size:12px">No conversations yet.</p>';
    } catch(e) { console.error(e); }
  }

  // ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ
  let _settings = [];

  // ‚îÄ‚îÄ MODELS ‚îÄ‚îÄ
  async function loadModels() {
    try {
      const data = await api('/models');

      // Status boxes
      document.getElementById('modelStatus').innerHTML = `
        <div class="stat-box">
          <div class="stat-label">Claude</div>
          <div class="stat-value">${data.claude_available ? '<span style="color:var(--success)">Online</span>' : '<span style="color:var(--error)">Offline</span>'}</div>
          <div class="stat-sub">${esc(data.claude_model||'‚Äî')}</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Ollama</div>
          <div class="stat-value">${data.ollama_available ? '<span style="color:var(--success)">Online</span>' : '<span style="color:var(--error)">Offline</span>'}</div>
          <div class="stat-sub">${esc(data.ollama_model||'‚Äî')}</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Routing</div>
          <div class="stat-value">${data.complexity_threshold}</div>
          <div class="stat-sub">threshold</div>
        </div>
      `;

      // Populate fields
      document.getElementById('mdl_claude_model').value = data.claude_model || '';
      document.getElementById('mdl_ollama_url').value = data.ollama_base_url || '';
      document.getElementById('mdl_ollama_model').value = data.ollama_model || '';
      const slider = document.getElementById('mdl_threshold');
      slider.value = data.complexity_threshold || 60;
      document.getElementById('mdl_threshold_val').textContent = slider.value;
      slider.oninput = () => { document.getElementById('mdl_threshold_val').textContent = slider.value; };

      // API key ‚Äî don't load, just show placeholder based on whether it's set
      document.getElementById('mdl_anthropic_key').placeholder = data.claude_available ? 'Key set (enter new to change)' : 'sk-ant-...';
    } catch(e) { console.error('Failed to load models:', e); }
  }

  async function saveModelSettings() {
    const updates = {};
    document.querySelectorAll('[data-mdl]').forEach(el => {
      const key = el.dataset.mdl;
      const val = el.value;
      if (key === 'ANTHROPIC_API_KEY') {
        if (val && !val.startsWith('Key set')) updates[key] = val;
      } else {
        updates[key] = val;
      }
    });

    if (!Object.keys(updates).length) { toast('No changes', 'info'); return; }

    try {
      const data = await api('/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({updates}) });
      toast(data.message || 'Settings saved', 'success');
      setTimeout(loadModels, 1000);  // Refresh status after reconnection
    } catch(e) { toast('Save failed: ' + e.message, 'error'); }
  }

  async function testModel(which) {
    const key = which === 'claude' ? 'ANTHROPIC_API_KEY' : 'OLLAMA_BASE_URL';
    toast(`Testing ${which}...`, 'info');
    try {
      const data = await api(`/settings/test/${key}`, {method:'POST'});
      toast(data.success ? data.message : `Failed: ${data.error}`, data.success ? 'success' : 'error');
    } catch(e) { toast('Test failed: ' + e.message, 'error'); }
  }

  async function fetchOllamaModels() {
    const container = document.getElementById('ollamaModelList');
    container.innerHTML = '<span style="font-size:11px;color:var(--text-muted)">Loading...</span>';
    try {
      const data = await api('/models/ollama-list');
      if (!data.success || !data.models.length) {
        container.innerHTML = `<span style="font-size:11px;color:var(--error)">${esc(data.error||'No models found')}</span>`;
        return;
      }
      container.innerHTML = data.models.map(m => {
        const sizeGB = (m.size / 1e9).toFixed(1);
        return `<button class="btn btn-secondary btn-sm" style="margin:2px" onclick="document.getElementById('mdl_ollama_model').value='${esc(m.name)}'">${esc(m.name)} <span style="opacity:0.5">${sizeGB}GB</span></button>`;
      }).join('');
    } catch(e) { container.innerHTML = `<span style="font-size:11px;color:var(--error)">Failed: ${esc(e.message)}</span>`; }
  }
  async function loadSettings() {
    try {
      const data = await api('/settings');
      _settings = data.settings;
      renderSettings(data.settings);
    } catch(e) { document.getElementById('settingsContainer').innerHTML = '<p style="color:var(--error)">Failed to load.</p>'; }
  }

  function renderSettings(settings) {
    const groups = {};
    settings.forEach(s => { if (!groups[s.category]) groups[s.category] = []; groups[s.category].push(s); });
    let html = '';
    for (const [section, fields] of Object.entries(groups)) {
      if (section === 'Persona') continue; // handled in Persona page
      html += `<div class="card"><div class="card-header">${esc(section)}</div>`;
      for (const f of fields) {
        const testable = ['ANTHROPIC_API_KEY','OLLAMA_BASE_URL','GITHUB_TOKEN'].includes(f.key);
        html += `<div class="field"><label>${esc(f.label)}</label><div class="field-desc">${esc(f.description||'')}</div>`;
        if (f.type === 'select') {
          html += `<select data-key="${f.key}">${(f.options||[]).map(o => `<option value="${esc(o)}" ${f.value===o?'selected':''}>${esc(o)}</option>`).join('')}</select>`;
        } else if (f.type === 'range') {
          html += `<div class="range-display" id="rv_${f.key}">${esc(f.value||String(f.min||0))}</div>`;
          html += `<input type="range" data-key="${f.key}" min="${f.min||0}" max="${f.max||100}" value="${esc(f.value||String(f.min||0))}" oninput="document.getElementById('rv_${f.key}').textContent=this.value">`;
          html += `<div class="range-labels"><span>${f.min||0} (always Claude)</span><span>${f.max||100} (always local)</span></div>`;
        } else if (f.type === 'password') {
          const ph = f.has_value ? 'Value set ‚Äî enter new to change' : 'Not set';
          html += `<div class="field-row"><div class="field" style="margin:0"><div class="pw-wrapper"><input type="password" data-key="${f.key}" placeholder="${ph}" value=""><button class="pw-toggle" onclick="togglePw(this)">show</button></div></div>`;
          if (testable) html += `<button class="btn btn-secondary btn-sm" onclick="testKey('${f.key}')">Test</button>`;
          html += `</div>`;
        } else if (f.type === 'number') {
          html += `<input type="number" data-key="${f.key}" min="${f.min||''}" max="${f.max||''}" value="${esc(f.value||'')}">`;
        } else {
          html += `<div class="field-row"><div class="field" style="margin:0"><input type="text" data-key="${f.key}" value="${esc(f.value||'')}"></div>`;
          if (testable) html += `<button class="btn btn-secondary btn-sm" onclick="testKey('${f.key}')">Test</button>`;
          html += `</div>`;
        }
        html += `</div>`;
      }
      html += `</div>`;
    }
    document.getElementById('settingsContainer').innerHTML = html;
  }

  function togglePw(btn) { const inp = btn.parentElement.querySelector('input'); const show = inp.type==='password'; inp.type = show?'text':'password'; btn.textContent = show?'hide':'show'; }

  async function saveSettings() {
    const updates = {};
    document.querySelectorAll('#pg-settings [data-key]').forEach(el => {
      const key = el.dataset.key; const val = el.value;
      const s = _settings.find(x => x.key === key);
      if (s && s.type === 'password') { if (val) updates[key] = val; }
      else updates[key] = val;
    });
    if (!Object.keys(updates).length) { toast('No changes to save', 'info'); return; }
    try {
      const data = await api('/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({updates}) });
      toast(data.message || `Saved ${data.count} settings`, 'success');
    } catch(e) { toast('Save failed: ' + e.message, 'error'); }
  }

  async function testKey(key) {
    toast(`Testing ${key}...`, 'info');
    try {
      const data = await api(`/settings/test/${key}`, {method:'POST'});
      toast(data.success ? data.message : `Failed: ${data.error}`, data.success ? 'success' : 'error');
    } catch(e) { toast('Test failed', 'error'); }
  }

  // ‚îÄ‚îÄ PLUGINS ‚îÄ‚îÄ
  async function loadPlugins() {
    try {
      const data = await api('/plugins');
      let html = '';

      // Active plugins
      for (const p of (data.active||[])) {
        const hOk = p.health?.status === 'ok';
        html += `<div class="plugin-card"><div class="plugin-header"><h4>üîå ${esc(p.name)}</h4><span class="badge ${hOk?'badge-ok':'badge-err'}">${hOk?'Active':'Error'}</span></div>`;
        html += `<div class="plugin-desc">${esc(p.description)}</div>`;
        html += `<div class="plugin-meta">v${esc(p.version)} ¬∑ ${p.tools.length} tools ¬∑ ${p.commands.length} commands</div>`;
        if (!hOk && p.health?.message) html += `<div style="margin-top:6px;font-size:11px;color:var(--error)">‚ö† ${esc(p.health.message)}</div>`;
        if (p.tools.length) {
          html += `<div class="plugin-tools">${p.tools.map(t => `<div>‚Ä¢ <strong>${esc(t.name)}</strong> ‚Äî ${esc(t.description)}</div>`).join('')}</div>`;
        }
        if (p.commands.length) html += `<div style="margin-top:6px;font-size:11px;color:var(--text-muted)">Commands: ${p.commands.map(c => '<code>'+esc(c.command)+'</code>').join(', ')}</div>`;
        html += `<div class="btn-row"><button class="btn btn-secondary btn-sm" onclick="reloadPlugin('${esc(p.name)}')">‚Üª Reload</button></div></div>`;
      }

      // Inactive plugins ‚Äî now with an ACTIVATE button
      for (const p of (data.available||[])) {
        html += `<div class="plugin-card" style="border-color:var(--border-light)"><div class="plugin-header"><h4>üì¶ ${esc(p.name)}</h4><span class="badge badge-off">Inactive</span></div>`;
        html += `<div class="plugin-desc" style="color:var(--text-muted)">${esc(p.reason)}</div>`;
        html += `<div class="plugin-meta">File: ${esc(p.file)}</div>`;
        html += `<div class="btn-row"><button class="btn btn-primary btn-sm" onclick="activatePlugin('${esc(p.name)}')">‚ö° Activate Plugin</button></div></div>`;
      }

      if (!data.active?.length && !data.available?.length) html = '<p style="color:var(--text-muted)">No plugins found in <code>backend/plugins/</code>.</p>';

      html += `<div class="card" style="margin-top:16px"><div class="card-header">Create a Plugin</div><p style="font-size:12px;color:var(--text-secondary);line-height:1.6">Create a <code>yourname_plugin.py</code> in <code>backend/plugins/</code>, extend <code>NexusPlugin</code>, configure any API keys in Settings, then click <strong>Reload All Plugins</strong> above.</p></div>`;
      document.getElementById('pluginsContainer').innerHTML = html;
    } catch(e) { document.getElementById('pluginsContainer').innerHTML = '<p style="color:var(--error)">Failed to load plugins: '+esc(e.message)+'</p>'; }
  }

  async function reloadPlugin(name) {
    toast(`Reloading ${name}...`, 'info');
    try {
      const data = await api(`/plugins/${name}/reload`, {method:'POST'});
      toast(data.success ? data.message : `Failed: ${data.error}`, data.success ? 'success' : 'error');
      setTimeout(loadPlugins, 500);
    } catch(e) { toast('Reload failed: ' + e.message, 'error'); }
  }

  async function activatePlugin(name) {
    toast(`Activating ${name}...`, 'info');
    try {
      const data = await api(`/plugins/${name}/reload`, {method:'POST'});
      if (data.success) {
        toast(data.message, 'success');
      } else {
        // Common failure: missing config. Guide user.
        let msg = data.error || 'Unknown error';
        if (msg.includes('setup() returned False')) {
          msg += ' ‚Äî check Settings tab for required API keys, then try again.';
        }
        toast(msg, 'error');
      }
      setTimeout(loadPlugins, 500);
    } catch(e) { toast('Activation failed: ' + e.message, 'error'); }
  }

  async function reloadAllPlugins() {
    toast('Reloading all plugins...', 'info');
    try {
      const data = await api('/plugins/reload-all', {method:'POST'});
      toast(data.success ? data.message : `Failed: ${data.error}`, data.success ? 'success' : 'error');
      setTimeout(loadPlugins, 500);
    } catch(e) { toast('Reload failed: ' + e.message, 'error'); }
  }

  async function restartServer() {
    if (!confirm('Restart the Nexus server? You will briefly lose connection.')) return;
    toast('Restarting server...', 'info');
    try {
      await api('/restart', {method:'POST'});
    } catch(e) { /* expected ‚Äî server is shutting down */ }
    // Poll until server is back
    setTimeout(async () => {
      let attempts = 0;
      const check = async () => {
        try {
          await fetch('/api/status');
          toast('Server restarted!', 'success');
          setTimeout(() => location.reload(), 500);
        } catch(e) {
          if (++attempts < 30) setTimeout(check, 1000);
          else toast('Server did not come back ‚Äî check terminal', 'error');
        }
      };
      check();
    }, 2000);
  }

  // ‚îÄ‚îÄ PERSONA ‚îÄ‚îÄ
  async function loadPersona() {
    try {
      const data = await api('/settings');
      (data.settings||[]).forEach(s => {
        if (s.key === 'AGENT_NAME') document.getElementById('pName').value = s.value || 'Nexus';
        if (s.key === 'PERSONA_TONE') document.getElementById('pTone').value = s.value || 'balanced';
        if (s.key === 'CUSTOM_SYSTEM_PROMPT') document.getElementById('pInstructions').value = (s.value||'').replace(/\\n/g, '\n');
      });
      const prompt = await api('/system-prompt');
      document.getElementById('promptPreview').textContent = prompt.full_prompt || '';
    } catch(e) { console.error(e); }
  }

  async function savePersona() {
    const updates = {};
    document.querySelectorAll('#pg-persona [data-key]').forEach(el => { updates[el.dataset.key] = el.value; });
    try {
      const data = await api('/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({updates}) });
      toast('Persona saved!', 'success');
      const prompt = await api('/system-prompt');
      document.getElementById('promptPreview').textContent = prompt.full_prompt || '';
    } catch(e) { toast('Save failed', 'error'); }
  }

  // ‚îÄ‚îÄ CONVERSATIONS ‚îÄ‚îÄ
  async function loadConversations() {
    try {
      const convs = await api('/conversations');
      if (!convs.length) { document.getElementById('convsContainer').innerHTML = '<p style="color:var(--text-muted)">No conversations yet.</p>'; return; }
      let html = '<table class="data-table"><thead><tr><th>Title</th><th>Messages</th><th>Updated</th><th></th></tr></thead><tbody>';
      for (const c of convs) {
        const date = c.updated_at ? new Date(c.updated_at).toLocaleDateString() : '‚Äî';
        html += `<tr><td>${esc(c.title||'Untitled')}</td><td>${c.message_count||0}</td><td style="color:var(--text-muted);font-family:var(--font-mono);font-size:11px">${date}</td>`;
        html += `<td><button class="btn btn-danger btn-sm" onclick="deleteConv('${c.id}')">Delete</button></td></tr>`;
      }
      html += '</tbody></table>';
      document.getElementById('convsContainer').innerHTML = html;
    } catch(e) { console.error(e); }
  }

  async function deleteConv(id) {
    if (!confirm('Delete this conversation?')) return;
    await api(`/conversations/${id}`, {method:'DELETE'});
    toast('Deleted', 'success');
    loadConversations();
  }

  async function clearAllConversations() {
    if (!confirm('Delete ALL conversation history? This cannot be undone.')) return;
    const data = await api('/conversations', {method:'DELETE'});
    toast(`Cleared ${data.deleted} conversations`, 'success');
    loadConversations();
  }

  // ‚îÄ‚îÄ LOGS ‚îÄ‚îÄ
  let _logSSE = null; let _allLogs = [];
  function initLogs() {
    if (_logSSE) return;
    // Load existing
    api('/logs').then(logs => { _allLogs = logs; renderLogs(); }).catch(()=>{});
    // SSE stream
    _logSSE = new EventSource('/api/admin/logs/stream');
    _logSSE.onopen = () => { document.getElementById('logStatus').textContent = 'Live'; document.getElementById('logStatus').style.color = 'var(--success)'; };
    _logSSE.onmessage = (e) => {
      const entry = JSON.parse(e.data);
      _allLogs.push(entry);
      if (_allLogs.length > 500) _allLogs.shift();
      renderLogs();
    };
    _logSSE.onerror = () => { document.getElementById('logStatus').textContent = 'Reconnecting...'; document.getElementById('logStatus').style.color = 'var(--warning)'; };
  }

  function renderLogs() {
    const filter = document.getElementById('logFilter').value;
    const viewer = document.getElementById('logViewer');
    const wasAtBottom = viewer.scrollHeight - viewer.scrollTop - viewer.clientHeight < 50;
    const filtered = filter === 'all' ? _allLogs : _allLogs.filter(l => l.level === filter);
    viewer.innerHTML = filtered.map(l => {
      const ts = l.ts ? l.ts.split('T')[1]?.split('.')[0] || '' : '';
      return `<div class="log-entry"><span class="ts">${ts}</span> <span class="lvl-${l.level}">${l.level}</span> ${esc(l.msg)}</div>`;
    }).join('');
    if (wasAtBottom) viewer.scrollTop = viewer.scrollHeight;
  }

  function filterLogs() { renderLogs(); }
  function clearLogViewer() { _allLogs = []; renderLogs(); }

  // ‚îÄ‚îÄ SYSTEM ‚îÄ‚îÄ
  async function loadSystem() {
    try {
      const [sys, usage, backups] = await Promise.all([api('/system'), api('/usage'), api('/backups')]);
      document.getElementById('sysInfo').innerHTML = `
        Python: ${esc(sys.python_version)}<br>Platform: ${esc(sys.platform)}<br>
        Base: <code>${esc(sys.base_dir)}</code><br>Skills: <code>${esc(sys.skills_dir)}</code> (${sys.skills_count} files)<br>
        Docs: <code>${esc(sys.docs_dir)}</code><br>DB: <code>${esc(sys.db_path)}</code> (${sys.db_size_mb} MB)
      `;
      let uhtml = '<table class="data-table"><thead><tr><th>Model</th><th>Messages</th><th>Tokens In</th><th>Tokens Out</th></tr></thead><tbody>';
      for (const t of (usage.totals||[])) {
        uhtml += `<tr><td>${esc(t.model_used||'‚Äî')}</td><td>${t.message_count}</td><td>${(t.total_tokens_in||0).toLocaleString()}</td><td>${(t.total_tokens_out||0).toLocaleString()}</td></tr>`;
      }
      uhtml += '</tbody></table>';
      if (!usage.totals?.length) uhtml = '<p style="color:var(--text-muted);font-size:12px">No usage data yet.</p>';
      document.getElementById('usageStats').innerHTML = uhtml;

      let bhtml = '';
      for (const b of (backups||[])) {
        bhtml += `<div style="padding:6px 0;border-bottom:1px solid var(--border);font-size:12px;display:flex;justify-content:space-between"><span style="font-family:var(--font-mono)">${esc(b.file)}</span><span style="color:var(--text-muted)">${b.size_mb} MB</span></div>`;
      }
      document.getElementById('backupsList').innerHTML = bhtml || '<p style="color:var(--text-muted);font-size:12px">No backups yet.</p>';
    } catch(e) { console.error(e); }
  }

  async function createBackup() {
    try {
      const data = await api('/backup', {method:'POST'});
      toast(`Backup created: ${data.size_mb} MB`, 'success');
      loadSystem();
    } catch(e) { toast('Backup failed', 'error'); }
  }

  // ‚îÄ‚îÄ USERS ‚îÄ‚îÄ
  async function loadUsers() {
    try {
      const users = await api('/users');
      if (!users.length) { document.getElementById('usersContainer').innerHTML = '<p style="color:var(--text-muted)">No users yet.</p>'; return; }
      let html = '<table class="data-table"><thead><tr><th>Email</th><th>Name</th><th>Role</th><th>Status</th><th>Last Login</th><th>Actions</th></tr></thead><tbody>';
      for (const u of users) {
        const lastLogin = u.last_login ? new Date(u.last_login).toLocaleDateString() : 'Never';
        const statusBadge = u.active ? '<span class="badge badge-ok">Active</span>' : '<span class="badge badge-err">Disabled</span>';
        html += `<tr>
          <td>${esc(u.email)}</td>
          <td>${esc(u.name||'‚Äî')}</td>
          <td><select onchange="changeUserRole('${u.id}',this.value)" style="padding:4px 8px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px;">
            <option value="user" ${u.role==='user'?'selected':''}>user</option>
            <option value="admin" ${u.role==='admin'?'selected':''}>admin</option>
          </select></td>
          <td>${statusBadge}</td>
          <td style="font-family:var(--font-mono);font-size:11px;color:var(--text-muted)">${lastLogin}</td>
          <td>${u.active
            ? `<button class="btn btn-danger btn-sm" onclick="toggleUserStatus('${u.id}','deactivate')">Disable</button>`
            : `<button class="btn btn-success btn-sm" onclick="toggleUserStatus('${u.id}','activate')">Enable</button>`
          }</td>
        </tr>`;
      }
      html += '</tbody></table>';
      document.getElementById('usersContainer').innerHTML = html;
    } catch(e) { document.getElementById('usersContainer').innerHTML = `<p style="color:var(--error)">Failed: ${esc(e.message)}</p>`; }
  }

  async function changeUserRole(userId, role) {
    try {
      await api(`/users/${userId}/role`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({role}) });
      toast(`Role updated to ${role}`, 'success');
    } catch(e) { toast('Failed: ' + e.message, 'error'); loadUsers(); }
  }

  async function toggleUserStatus(userId, action) {
    try {
      await api(`/users/${userId}/${action}`, { method:'PUT' });
      toast(`User ${action}d`, 'success');
      loadUsers();
    } catch(e) { toast('Failed: ' + e.message, 'error'); }
  }

  // ‚îÄ‚îÄ WHITELIST ‚îÄ‚îÄ
  async function loadWhitelist() {
    try {
      const entries = await api('/whitelist');
      if (!entries.length) { document.getElementById('whitelistContainer').innerHTML = '<p style="color:var(--text-muted)">Whitelist is empty. In "open" mode, any Google user can sign in.</p>'; return; }
      let html = '<table class="data-table"><thead><tr><th>Email</th><th>Added By</th><th>Added</th><th></th></tr></thead><tbody>';
      for (const e of entries) {
        const date = e.added_at ? new Date(e.added_at).toLocaleDateString() : '‚Äî';
        html += `<tr><td>${esc(e.email)}</td><td>${esc(e.added_by||'‚Äî')}</td><td style="font-family:var(--font-mono);font-size:11px;color:var(--text-muted)">${date}</td>
          <td><button class="btn btn-danger btn-sm" onclick="removeFromWhitelist('${esc(e.email)}')">Remove</button></td></tr>`;
      }
      html += '</tbody></table>';
      document.getElementById('whitelistContainer').innerHTML = html;
    } catch(e) { document.getElementById('whitelistContainer').innerHTML = `<p style="color:var(--error)">Failed: ${esc(e.message)}</p>`; }
  }

  async function addToWhitelist() {
    const email = document.getElementById('wlEmail').value.trim();
    if (!email) { toast('Enter an email', 'error'); return; }
    try {
      await api('/whitelist', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email}) });
      toast(`${email} added to whitelist`, 'success');
      document.getElementById('wlEmail').value = '';
      loadWhitelist();
    } catch(e) { toast('Failed: ' + e.message, 'error'); }
  }

  async function removeFromWhitelist(email) {
    if (!confirm(`Remove ${email} from whitelist?`)) return;
    try {
      await api(`/whitelist/${encodeURIComponent(email)}`, { method:'DELETE' });
      toast('Removed', 'success');
      loadWhitelist();
    } catch(e) { toast('Failed: ' + e.message, 'error'); }
  }

  // ‚îÄ‚îÄ IP SECURITY ‚îÄ‚îÄ
  async function loadBlockedIps() {
    try {
      const ips = await api('/blocked-ips');
      if (!ips.length) { document.getElementById('ipContainer').innerHTML = '<p style="color:var(--text-muted)">No blocked IPs.</p>'; return; }
      let html = '<table class="data-table"><thead><tr><th>IP Address</th><th>Reason</th><th>Blocked By</th><th>Date</th><th></th></tr></thead><tbody>';
      for (const ip of ips) {
        const date = ip.blocked_at ? new Date(ip.blocked_at).toLocaleDateString() : '‚Äî';
        html += `<tr><td style="font-family:var(--font-mono)">${esc(ip.ip_address)}</td><td>${esc(ip.reason||'‚Äî')}</td><td>${esc(ip.blocked_by||'‚Äî')}</td>
          <td style="font-family:var(--font-mono);font-size:11px;color:var(--text-muted)">${date}</td>
          <td><button class="btn btn-secondary btn-sm" onclick="unblockIp('${esc(ip.ip_address)}')">Unblock</button></td></tr>`;
      }
      html += '</tbody></table>';
      document.getElementById('ipContainer').innerHTML = html;
    } catch(e) { document.getElementById('ipContainer').innerHTML = `<p style="color:var(--error)">Failed: ${esc(e.message)}</p>`; }
  }

  async function blockIp() {
    const ip = document.getElementById('blockIp').value.trim();
    const reason = document.getElementById('blockReason').value.trim();
    if (!ip) { toast('Enter an IP address', 'error'); return; }
    try {
      await api('/blocked-ips', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ip, reason}) });
      toast(`${ip} blocked`, 'success');
      document.getElementById('blockIp').value = '';
      document.getElementById('blockReason').value = '';
      loadBlockedIps();
    } catch(e) { toast('Failed: ' + e.message, 'error'); }
  }

  async function unblockIp(ip) {
    if (!confirm(`Unblock ${ip}?`)) return;
    try {
      await api(`/blocked-ips/${encodeURIComponent(ip)}`, { method:'DELETE' });
      toast('Unblocked', 'success');
      loadBlockedIps();
    } catch(e) { toast('Failed: ' + e.message, 'error'); }
  }

  // ‚îÄ‚îÄ AUTH AUDIT ‚îÄ‚îÄ
  async function loadAuditLog() {
    try {
      const filter = document.getElementById('auditFilter')?.value || '';
      const url = filter ? `/auth-audit?event_type=${encodeURIComponent(filter)}` : '/auth-audit';
      const events = await api(url);
      if (!events.length) { document.getElementById('auditContainer').innerHTML = '<p style="color:var(--text-muted)">No audit events.</p>'; return; }
      let html = '<table class="data-table"><thead><tr><th>Time</th><th>Event</th><th>Email</th><th>IP</th><th>Result</th><th>Details</th></tr></thead><tbody>';
      for (const e of events) {
        const time = e.created_at ? new Date(e.created_at).toLocaleString() : '‚Äî';
        const badge = e.success ? '<span class="badge badge-ok">OK</span>' : '<span class="badge badge-err">Fail</span>';
        html += `<tr>
          <td style="font-family:var(--font-mono);font-size:11px;color:var(--text-muted);white-space:nowrap">${time}</td>
          <td><span style="font-family:var(--font-mono);font-size:11px">${esc(e.event_type)}</span></td>
          <td>${esc(e.email||'‚Äî')}</td>
          <td style="font-family:var(--font-mono);font-size:11px">${esc(e.ip_address||'‚Äî')}</td>
          <td>${badge}</td>
          <td style="font-size:11px;color:var(--text-muted);max-width:200px;overflow:hidden;text-overflow:ellipsis">${esc(e.details||'')}</td>
        </tr>`;
      }
      html += '</tbody></table>';
      document.getElementById('auditContainer').innerHTML = html;
    } catch(e) { document.getElementById('auditContainer').innerHTML = `<p style="color:var(--error)">Failed: ${esc(e.message)}</p>`; }
  }

  // ‚îÄ‚îÄ AUTH CHECK ‚îÄ‚îÄ
  async function checkAdminAuth() {
    try {
      const resp = await fetch('/api/auth/status');
      const status = await resp.json();
      if (!status.auth_enabled) return;

      // Show auth nav sections
      document.getElementById('navAuthSection').style.display = '';
      document.getElementById('navUsers').style.display = '';
      document.getElementById('navWhitelist').style.display = '';
      document.getElementById('navIpSecurity').style.display = '';
      document.getElementById('navAudit').style.display = '';

      // Check admin access
      const meResp = await fetch('/api/auth/me');
      if (!meResp.ok) { window.location.href = '/'; return; }
      const user = await meResp.json();
      if (user.role !== 'admin') {
        document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#ff6b6b;font-family:sans-serif;font-size:18px">Access denied. Admin role required.</div>';
      }
    } catch(e) { console.error('Admin auth check failed:', e); }
  }

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  checkAdminAuth();
  loadDashboard();
</script>
</body>
</html>
