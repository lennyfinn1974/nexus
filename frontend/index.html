<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nexus</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a0a0f;
    --bg-secondary: #12121a;
    --bg-tertiary: #1a1a26;
    --bg-hover: #222233;
    --text-primary: #e8e8f0;
    --text-secondary: #8888a8;
    --text-muted: #555570;
    --accent: #6c5ce7;
    --accent-dim: #4a3db5;
    --accent-glow: rgba(108, 92, 231, 0.15);
    --success: #00d2a0;
    --warning: #ffa94d;
    --error: #ff6b6b;
    --border: #2a2a3a;
    --border-light: #333346;
    --radius: 12px;
    --radius-sm: 8px;
    --font-sans: 'DM Sans', -apple-system, sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font-sans);
    background: var(--bg-primary);
    color: var(--text-primary);
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  .sidebar {
    width: 280px;
    background: var(--bg-secondary);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
  }

  .sidebar-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--accent), #a78bfa);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 16px; color: #fff;
  }

  .sidebar-header h1 {
    font-size: 18px; font-weight: 700; letter-spacing: -0.02em;
  }

  .sidebar-header .version {
    font-size: 11px; color: var(--text-muted);
    font-family: var(--font-mono);
  }

  .sidebar-section { padding: 16px 12px 8px; }
  .sidebar-section-title {
    font-size: 10px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.08em; color: var(--text-muted); padding: 0 8px 8px;
  }

  .sidebar-btn {
    width: 100%; padding: 10px 12px; background: none; border: none;
    color: var(--text-secondary); font-family: var(--font-sans);
    font-size: 13px; text-align: left; border-radius: var(--radius-sm);
    cursor: pointer; display: flex; align-items: center; gap: 10px;
    transition: all 0.15s;
  }
  .sidebar-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
  .sidebar-btn.active { background: var(--accent-glow); color: var(--accent); }
  .sidebar-btn svg { width: 16px; height: 16px; flex-shrink: 0; }

  .new-chat-btn {
    margin: 12px;
    padding: 10px 16px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: var(--radius-sm);
    font-family: var(--font-sans);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
    display: flex; align-items: center; gap: 8px; justify-content: center;
  }
  .new-chat-btn:hover { background: var(--accent-dim); }

  .conversations-list {
    flex: 1; overflow-y: auto; padding: 0 8px;
  }
  .conversations-list::-webkit-scrollbar { width: 4px; }
  .conversations-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .conv-item {
    padding: 8px 10px; margin-bottom: 2px; border-radius: 6px;
    cursor: pointer; font-size: 12px; color: var(--text-secondary);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    transition: all 0.15s; display: flex; align-items: center; gap: 6px;
    position: relative;
  }
  .conv-item:hover { background: var(--bg-hover); color: var(--text-primary); }
  .conv-item.active { background: var(--accent-glow); color: var(--accent); }
  .conv-item .conv-title { flex: 1; overflow: hidden; text-overflow: ellipsis; }
  .conv-item .conv-delete {
    display: none; background: none; border: none; color: var(--text-muted);
    cursor: pointer; font-size: 14px; padding: 0 2px; flex-shrink: 0;
  }
  .conv-item:hover .conv-delete { display: block; }
  .conv-item .conv-delete:hover { color: var(--error); }

  /* ‚îÄ‚îÄ Status Bar ‚îÄ‚îÄ */
  .status-bar {
    padding: 12px 16px;
    border-top: 1px solid var(--border);
    display: flex; flex-direction: column; gap: 6px;
  }
  .status-item {
    display: flex; align-items: center; gap: 8px; font-size: 11px;
    font-family: var(--font-mono); color: var(--text-muted);
  }
  .status-dot {
    width: 6px; height: 6px; border-radius: 50%;
  }
  .status-dot.on { background: var(--success); box-shadow: 0 0 6px var(--success); }
  .status-dot.off { background: var(--error); }

  /* ‚îÄ‚îÄ Main Area ‚îÄ‚îÄ */
  .main {
    flex: 1; display: flex; flex-direction: column;
    min-width: 0;
  }

  .topbar {
    height: 56px;
    padding: 0 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .topbar-title {
    font-size: 14px; font-weight: 600;
  }

  .topbar-actions {
    display: flex; gap: 8px;
  }

  .icon-btn {
    width: 34px; height: 34px;
    background: none; border: 1px solid var(--border);
    border-radius: var(--radius-sm); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: var(--text-secondary); transition: all 0.15s;
  }
  .icon-btn:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-light); }

  /* ‚îÄ‚îÄ Messages ‚îÄ‚îÄ */
  .messages {
    flex: 1; overflow-y: auto; padding: 24px;
    display: flex; flex-direction: column; gap: 2px;
  }
  .messages::-webkit-scrollbar { width: 6px; }
  .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .message-group { display: flex; flex-direction: column; gap: 2px; margin-bottom: 16px; }

  .message {
    max-width: 75%;
    padding: 12px 16px;
    font-size: 14px;
    line-height: 1.6;
    word-wrap: break-word;
  }

  .message.user {
    align-self: flex-end;
    background: var(--accent);
    color: #fff;
    border-radius: 18px 18px 4px 18px;
  }

  .message.assistant {
    align-self: flex-start;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 18px 18px 18px 4px;
  }

  .message.system {
    align-self: center;
    background: transparent;
    color: var(--text-muted);
    font-size: 12px;
    font-style: italic;
    padding: 6px 12px;
  }

  .message-meta {
    font-size: 10px;
    color: var(--text-muted);
    font-family: var(--font-mono);
    padding: 2px 8px;
  }
  .message-meta.user-meta { align-self: flex-end; }
  .message-meta.assistant-meta { align-self: flex-start; }

  .model-badge {
    display: inline-block;
    padding: 1px 6px;
    background: var(--bg-hover);
    border-radius: 4px;
    font-size: 10px;
    color: var(--text-muted);
    font-family: var(--font-mono);
  }

  .message code {
    font-family: var(--font-mono);
    background: rgba(0,0,0,0.3);
    padding: 1px 5px;
    border-radius: 4px;
    font-size: 12px;
  }

  .message pre {
    background: rgba(0,0,0,0.4);
    padding: 12px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 8px 0;
    font-family: var(--font-mono);
    font-size: 12px;
    line-height: 1.5;
  }

  .typing-indicator {
    align-self: flex-start;
    padding: 12px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 18px 18px 18px 4px;
    display: none;
  }
  .typing-indicator.visible { display: flex; gap: 4px; align-items: center; }
  .typing-dot {
    width: 6px; height: 6px; background: var(--text-muted);
    border-radius: 50%; animation: typingBounce 1.4s infinite;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typingBounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-6px); }
  }

  /* ‚îÄ‚îÄ Welcome Screen ‚îÄ‚îÄ */
  .welcome {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 16px;
    color: var(--text-muted); padding: 40px;
  }
  .welcome-logo {
    width: 64px; height: 64px;
    background: linear-gradient(135deg, var(--accent), #a78bfa);
    border-radius: 20px;
    display: flex; align-items: center; justify-content: center;
    font-size: 28px; font-weight: 700; color: #fff;
    box-shadow: 0 8px 32px var(--accent-glow);
  }
  .welcome h2 { font-size: 22px; color: var(--text-primary); }
  .welcome p { font-size: 14px; max-width: 400px; text-align: center; line-height: 1.6; }
  .welcome-commands {
    display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
    margin-top: 12px; width: 100%; max-width: 440px;
  }
  .welcome-cmd {
    padding: 10px 14px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-family: var(--font-mono);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s;
  }
  .welcome-cmd:hover { border-color: var(--accent); color: var(--accent); }

  /* ‚îÄ‚îÄ Input Area ‚îÄ‚îÄ */
  .input-area {
    padding: 16px 24px 20px;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }

  .input-wrapper {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 8px 8px 8px 16px;
    transition: border-color 0.2s;
  }
  .input-wrapper:focus-within { border-color: var(--accent); }

  .input-wrapper textarea {
    flex: 1;
    background: none;
    border: none;
    color: var(--text-primary);
    font-family: var(--font-sans);
    font-size: 14px;
    line-height: 1.5;
    resize: none;
    outline: none;
    max-height: 120px;
    padding: 6px 0;
  }
  .input-wrapper textarea::placeholder { color: var(--text-muted); }

  .send-btn {
    width: 38px; height: 38px;
    background: var(--accent);
    border: none; border-radius: 10px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: #fff;
    transition: background 0.15s;
    flex-shrink: 0;
  }
  .send-btn:hover { background: var(--accent-dim); }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ‚îÄ‚îÄ Panels ‚îÄ‚îÄ */
  .panel {
    position: fixed; top: 0; right: -420px;
    width: 400px; height: 100vh;
    background: var(--bg-secondary);
    border-left: 1px solid var(--border);
    z-index: 100;
    transition: right 0.25s ease;
    display: flex; flex-direction: column;
  }
  .panel.open { right: 0; }
  .admin-panel-wide { width: 480px; right: -500px; }
  .admin-panel-wide.open { right: 0; }
  .panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
  }
  .panel-header h3 { font-size: 15px; font-weight: 600; }
  .panel-body { flex: 1; overflow-y: auto; padding: 16px; }
  .panel-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.4);
    z-index: 99; display: none;
  }
  .panel-overlay.visible { display: block; }

  .skill-card {
    padding: 14px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    margin-bottom: 10px;
  }
  .skill-card h4 { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
  .skill-card p { font-size: 12px; color: var(--text-secondary); line-height: 1.4; }
  .skill-card .skill-meta {
    margin-top: 8px;
    display: flex; justify-content: space-between; align-items: center;
    font-size: 10px; font-family: var(--font-mono); color: var(--text-muted);
  }
  .skill-delete {
    background: none; border: none; color: var(--error);
    font-size: 11px; cursor: pointer; opacity: 0.6;
  }
  .skill-delete:hover { opacity: 1; }

  /* ‚îÄ‚îÄ Login Overlay ‚îÄ‚îÄ */
  .login-overlay {
    position: fixed; inset: 0; z-index: 500;
    background: var(--bg-primary);
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 24px;
  }
  .login-overlay.hidden { display: none; }
  .login-box {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 40px;
    text-align: center;
    max-width: 400px; width: 90%;
  }
  .login-box .login-logo {
    width: 64px; height: 64px;
    background: linear-gradient(135deg, var(--accent), #a78bfa);
    border-radius: 20px;
    display: flex; align-items: center; justify-content: center;
    font-size: 28px; font-weight: 700; color: #fff;
    margin: 0 auto 16px;
    box-shadow: 0 8px 32px var(--accent-glow);
  }
  .login-box h2 { font-size: 22px; margin-bottom: 8px; }
  .login-box p { font-size: 14px; color: var(--text-secondary); margin-bottom: 24px; }
  .google-btn {
    display: inline-flex; align-items: center; gap: 10px;
    padding: 12px 24px;
    background: #fff; color: #333;
    border: none; border-radius: 8px;
    font-family: var(--font-sans); font-size: 14px; font-weight: 600;
    cursor: pointer; transition: box-shadow 0.2s;
  }
  .google-btn:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
  .google-btn svg { width: 20px; height: 20px; }
  .login-error {
    margin-top: 16px; padding: 10px 14px;
    background: rgba(255,107,107,0.15); color: var(--error);
    border-radius: 6px; font-size: 13px;
    display: none;
  }
  .login-error.visible { display: block; }

  /* ‚îÄ‚îÄ User Info (sidebar footer) ‚îÄ‚îÄ */
  .user-info {
    padding: 12px 16px;
    border-top: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
  }
  .user-info.hidden { display: none; }
  .user-avatar {
    width: 30px; height: 30px; border-radius: 50%;
    background: var(--accent-glow); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 600; color: var(--accent);
    overflow: hidden; flex-shrink: 0;
  }
  .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .user-details { flex: 1; min-width: 0; }
  .user-name { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .user-role { font-size: 10px; color: var(--text-muted); font-family: var(--font-mono); }
  .signout-btn {
    background: none; border: none; color: var(--text-muted);
    font-size: 11px; cursor: pointer; padding: 4px;
  }
  .signout-btn:hover { color: var(--error); }

  /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    .sidebar { width: 0; overflow: hidden; }
    .message { max-width: 90%; }
  }

  /* ‚îÄ‚îÄ Admin Panel ‚îÄ‚îÄ */
  .admin-tabs {
    display: flex; border-bottom: 1px solid var(--border);
    padding: 0 16px; gap: 0; flex-shrink: 0;
  }
  .admin-tab {
    padding: 10px 14px; background: none; border: none;
    color: var(--text-muted); font-family: var(--font-sans);
    font-size: 12px; font-weight: 500; cursor: pointer;
    border-bottom: 2px solid transparent; transition: all 0.15s;
  }
  .admin-tab:hover { color: var(--text-secondary); }
  .admin-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  .admin-section { display: none; padding: 16px; }
  .admin-section.active { display: block; }

  .admin-group {
    margin-bottom: 20px;
  }
  .admin-group-title {
    font-size: 11px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.06em; color: var(--text-muted);
    margin-bottom: 10px; padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }

  .admin-field {
    margin-bottom: 14px;
  }
  .admin-field label {
    display: block; font-size: 12px; font-weight: 500;
    color: var(--text-secondary); margin-bottom: 4px;
  }
  .admin-field .field-desc {
    font-size: 10px; color: var(--text-muted); margin-bottom: 6px;
  }
  .admin-field input[type="text"],
  .admin-field input[type="password"],
  .admin-field input[type="number"],
  .admin-field select,
  .admin-field textarea {
    width: 100%; padding: 8px 10px;
    background: var(--bg-tertiary); border: 1px solid var(--border);
    border-radius: 6px; color: var(--text-primary);
    font-family: var(--font-mono); font-size: 12px;
    outline: none; transition: border-color 0.15s;
  }
  .admin-field input:focus, .admin-field select:focus, .admin-field textarea:focus {
    border-color: var(--accent);
  }
  .admin-field textarea { min-height: 80px; resize: vertical; font-family: var(--font-sans); }

  .admin-field input[type="range"] {
    width: 100%; accent-color: var(--accent);
  }
  .range-labels {
    display: flex; justify-content: space-between;
    font-size: 10px; color: var(--text-muted); font-family: var(--font-mono);
  }
  .range-value {
    text-align: center; font-size: 18px; font-weight: 600;
    color: var(--accent); font-family: var(--font-mono); margin: 4px 0;
  }

  .admin-btn {
    padding: 8px 16px; border: none; border-radius: 6px;
    font-family: var(--font-sans); font-size: 12px; font-weight: 600;
    cursor: pointer; transition: all 0.15s;
  }
  .admin-btn-primary { background: var(--accent); color: #fff; }
  .admin-btn-primary:hover { background: var(--accent-dim); }
  .admin-btn-secondary { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border); }
  .admin-btn-secondary:hover { background: var(--bg-hover); color: var(--text-primary); }
  .admin-btn-danger { background: var(--error); color: #fff; opacity: 0.8; }
  .admin-btn-danger:hover { opacity: 1; }
  .admin-btn-row { display: flex; gap: 8px; margin-top: 16px; }

  .admin-toast {
    position: fixed; bottom: 24px; right: 24px;
    padding: 12px 20px; border-radius: 8px;
    font-size: 13px; font-weight: 500; z-index: 200;
    animation: toastIn 0.3s ease;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  }
  .admin-toast.success { background: var(--success); color: #000; }
  .admin-toast.error { background: var(--error); color: #fff; }
  .admin-toast.info { background: var(--accent); color: #fff; }
  @keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .plugin-card {
    padding: 14px; background: var(--bg-tertiary);
    border: 1px solid var(--border); border-radius: var(--radius-sm);
    margin-bottom: 10px;
  }
  .plugin-card-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 6px;
  }
  .plugin-card-header h4 { font-size: 13px; font-weight: 600; }
  .plugin-badge {
    padding: 2px 8px; border-radius: 10px; font-size: 10px;
    font-family: var(--font-mono); font-weight: 600;
  }
  .plugin-badge.active { background: rgba(0,210,160,0.15); color: var(--success); }
  .plugin-badge.inactive { background: rgba(255,107,107,0.15); color: var(--error); }

  .plugin-tools-list {
    margin-top: 8px; padding: 8px; background: var(--bg-primary);
    border-radius: 6px; font-size: 11px; font-family: var(--font-mono);
    color: var(--text-muted); max-height: 120px; overflow-y: auto;
  }
  .plugin-tools-list div { padding: 2px 0; }

  .toggle-switch {
    position: relative; width: 36px; height: 20px; cursor: pointer;
  }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute; inset: 0; background: var(--border);
    border-radius: 10px; transition: 0.2s;
  }
  .toggle-slider:before {
    content: ""; position: absolute; height: 14px; width: 14px;
    left: 3px; bottom: 3px; background: var(--text-muted);
    border-radius: 50%; transition: 0.2s;
  }
  .toggle-switch input:checked + .toggle-slider { background: var(--accent); }
  .toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(16px); background: #fff;
  }
</style>
</head>
<body>

<!-- Login Overlay (shown when auth enabled + not authenticated) -->
<div class="login-overlay hidden" id="loginOverlay">
  <div class="login-box">
    <div class="login-logo">N</div>
    <h2>Welcome to Nexus</h2>
    <p>Sign in to continue</p>
    <button class="google-btn" onclick="window.location.href='/api/auth/login'">
      <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Sign in with Google
    </button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- Sidebar -->
<aside class="sidebar">
  <div class="sidebar-header">
    <div class="logo">N</div>
    <div>
      <h1>Nexus</h1>
      <span class="version">v0.1.0</span>
    </div>
  </div>

  <button class="new-chat-btn" onclick="newChat()">
    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    New Chat
  </button>

  <div class="sidebar-section">
    <div class="sidebar-section-title">Tools</div>
    <button class="sidebar-btn" onclick="togglePanel('skills')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
      Skills
    </button>
    <button class="sidebar-btn" onclick="togglePanel('docs')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      Documents
    </button>
    <button class="sidebar-btn" onclick="togglePanel('tasks')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
      Tasks
    </button>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">System</div>
    <button class="sidebar-btn" onclick="window.location.href='/admin'">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      Admin
    </button>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">Recent Chats</div>
  </div>
  <div class="conversations-list" id="convList"></div>

  <div class="status-bar" id="statusBar">
    <div class="status-item"><span class="status-dot off" id="ollamaStatus"></span> Ollama</div>
    <div class="status-item"><span class="status-dot off" id="claudeStatus"></span> Claude</div>
  </div>

  <div class="user-info hidden" id="userInfo">
    <div class="user-avatar" id="userAvatar">?</div>
    <div class="user-details">
      <div class="user-name" id="userName">User</div>
      <div class="user-role" id="userRole">user</div>
    </div>
    <button class="signout-btn" onclick="signOut()" title="Sign Out">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
    </button>
  </div>
</aside>

<!-- Main -->
<main class="main">
  <div class="topbar">
    <span class="topbar-title" id="chatTitle">Nexus</span>
    <div class="topbar-actions">
      <button class="icon-btn" onclick="togglePanel('skills')" title="Skills">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
      </button>
      <button class="icon-btn" onclick="refreshStatus()" title="Refresh status">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
      </button>
      <button class="icon-btn" onclick="window.location.href='/admin'" title="Admin settings">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      </button>
    </div>
  </div>

  <div class="messages" id="messages">
    <div class="welcome" id="welcome">
      <div class="welcome-logo">N</div>
      <h2>Welcome to Nexus</h2>
      <p>Your personal AI agent. Ask me anything, or teach me something new.</p>
      <div class="welcome-commands">
        <div class="welcome-cmd" onclick="sendQuick('/learn web development best practices')">üî¨ /learn web development</div>
        <div class="welcome-cmd" onclick="sendQuick('/docs')">üìÇ /docs</div>
        <div class="welcome-cmd" onclick="sendQuick('/skills')">üìö /skills</div>
        <div class="welcome-cmd" onclick="sendQuick('/status')">üìä /status</div>
      </div>
    </div>
    <div class="typing-indicator" id="typing">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
  </div>

  <div class="input-area">
    <div class="input-wrapper">
      <textarea id="input" rows="1" placeholder="Send a message... (Shift+Enter for new line)" onkeydown="handleKey(event)" oninput="autoGrow(this)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="send()">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>
  </div>
</main>

<!-- Skills Panel -->
<div class="panel-overlay" id="panelOverlay" onclick="closePanel()"></div>
<div class="panel" id="skillsPanel">
  <div class="panel-header">
    <h3>üìö Learned Skills</h3>
    <button class="icon-btn" onclick="closePanel()">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="panel-body" id="skillsList">
    <p style="color:var(--text-muted);font-size:13px;">No skills learned yet. Use <code>/learn &lt;topic&gt;</code> to get started.</p>
  </div>
</div>

<!-- Documents Panel -->
<div class="panel" id="docsPanel">
  <div class="panel-header">
    <h3>üìÇ Documents</h3>
    <button class="icon-btn" onclick="closePanel()">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div style="padding:12px 16px 0; border-bottom:1px solid var(--border);">
    <button class="new-chat-btn" style="margin:0 0 12px;width:100%" onclick="ingestAll()">üì• Ingest All Documents</button>
    <p style="font-size:11px;color:var(--text-muted);padding-bottom:12px;" id="docsDir"></p>
  </div>
  <div class="panel-body" id="docsList">
    <p style="color:var(--text-muted);font-size:13px;">Loading...</p>
  </div>
</div>

<!-- Tasks Panel (original) -->
<div class="panel" id="tasksPanel">
  <div class="panel-header">
    <h3>üìã Background Tasks</h3>
    <button class="icon-btn" onclick="closePanel()">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="panel-body" id="tasksList">
    <p style="color:var(--text-muted);font-size:13px;">No tasks running.</p>
  </div>
</div>

<!-- Admin Panel -->
<div class="panel admin-panel-wide" id="adminPanel">
  <div class="panel-header">
    <h3>‚öôÔ∏è Admin</h3>
    <button class="icon-btn" onclick="closePanel()">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="admin-tabs">
    <button class="admin-tab active" onclick="switchAdminTab('settings', this)">Settings</button>
    <button class="admin-tab" onclick="switchAdminTab('plugins', this)">Plugins</button>
    <button class="admin-tab" onclick="switchAdminTab('persona', this)">Persona</button>
    <button class="admin-tab" onclick="switchAdminTab('system', this)">System</button>
  </div>
  <div class="panel-body" style="padding:0">

    <!-- Settings Tab -->
    <div class="admin-section active" id="adminSettings">
      <div id="settingsForm">
        <p style="color:var(--text-muted);font-size:13px;">Loading settings...</p>
      </div>
      <div class="admin-btn-row">
        <button class="admin-btn admin-btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
        <button class="admin-btn admin-btn-secondary" onclick="loadAdminSettings()">‚Üª Reload</button>
      </div>
    </div>

    <!-- Plugins Tab -->
    <div class="admin-section" id="adminPlugins">
      <div id="pluginsList">
        <p style="color:var(--text-muted);font-size:13px;">Loading plugins...</p>
      </div>
      <div style="margin-top:16px;padding:12px;background:var(--bg-tertiary);border-radius:8px;">
        <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;"><strong>Install a plugin:</strong></p>
        <p style="font-size:11px;color:var(--text-muted);line-height:1.5;">
          Copy <code>backend/plugins/_template.py</code>, rename it, implement your tools, and restart Nexus. Plugins are auto-discovered.
        </p>
      </div>
      <div class="admin-btn-row">
        <button class="admin-btn admin-btn-secondary" onclick="testModel('claude')">üß™ Test Claude</button>
        <button class="admin-btn admin-btn-secondary" onclick="testModel('ollama')">üß™ Test Ollama</button>
      </div>
    </div>

    <!-- Persona Tab -->
    <div class="admin-section" id="adminPersona">
      <div class="admin-group">
        <div class="admin-group-title">Agent Persona</div>
        <div class="admin-field">
          <label>Agent Name</label>
          <div class="field-desc">The name your agent uses to identify itself</div>
          <input type="text" id="personaName" value="Nexus" placeholder="Nexus">
        </div>
        <div class="admin-field">
          <label>Custom Instructions</label>
          <div class="field-desc">Additional personality or behaviour instructions appended to the system prompt</div>
          <textarea id="personaInstructions" placeholder="e.g. Always respond in British English. Focus on concise, technical answers. You work for Acme Corp."></textarea>
        </div>
      </div>
      <div class="admin-group">
        <div class="admin-group-title">Current System Prompt</div>
        <div style="padding:10px;background:var(--bg-primary);border-radius:6px;max-height:200px;overflow-y:auto;">
          <pre id="systemPromptPreview" style="font-size:11px;color:var(--text-muted);white-space:pre-wrap;margin:0;background:none;padding:0;"></pre>
        </div>
      </div>
      <div class="admin-btn-row">
        <button class="admin-btn admin-btn-primary" onclick="savePersona()">üíæ Save Persona</button>
      </div>
    </div>

    <!-- System Tab -->
    <div class="admin-section" id="adminSystem">
      <div class="admin-group">
        <div class="admin-group-title">System Info</div>
        <div id="systemInfo" style="font-size:12px;font-family:var(--font-mono);color:var(--text-secondary);line-height:1.8;"></div>
      </div>
      <div class="admin-group">
        <div class="admin-group-title">Database</div>
        <div class="admin-btn-row" style="margin-top:0">
          <button class="admin-btn admin-btn-secondary" onclick="sendQuick('/status')">üìä Check Status</button>
          <button class="admin-btn admin-btn-danger" onclick="clearConversations()">üóëÔ∏è Clear History</button>
        </div>
      </div>
      <div class="admin-group">
        <div class="admin-group-title">Restart</div>
        <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">Settings changes require a restart to take effect.</p>
        <div id="restartCommands" style="padding:10px;background:var(--bg-primary);border-radius:6px;font-family:var(--font-mono);font-size:11px;color:var(--text-muted);line-height:1.8;"></div>
      </div>
    </div>

  </div>
</div>

<script>
  // ‚îÄ‚îÄ Global error handler ‚Äî prevent silent JS death ‚îÄ‚îÄ
  window.onerror = function(msg, src, line, col, err) {
    console.error('JS Error:', msg, 'at', src, line, col, err);
    // Re-enable send button if an error killed the flow
    const btn = document.getElementById('sendBtn');
    if (btn) btn.disabled = false;
    const typing = document.getElementById('typing');
    if (typing) typing.classList.remove('visible');
  };

  // ‚îÄ‚îÄ State ‚îÄ‚îÄ
  let ws = null;
  let isStreaming = false;
  let currentStreamEl = null;
  let currentConvId = null;
  let convListCache = [];

  // ‚îÄ‚îÄ Persistent conversation ID ‚îÄ‚îÄ
  function saveConvId(id) {
    currentConvId = id;
    try {
      if (id) localStorage.setItem('nexus_conv_id', id);
      else localStorage.removeItem('nexus_conv_id');
    } catch(e) { /* localStorage might be blocked */ }
  }
  function getSavedConvId() {
    try { return localStorage.getItem('nexus_conv_id'); }
    catch(e) { return null; }
  }

  // ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ
  let wsReady = false;

  async function connect() {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    let wsUrl = `${proto}//${location.host}/ws/chat`;

    // If auth is enabled, get a short-lived WS token
    if (authEnabled) {
      try {
        const resp = await fetch('/api/auth/ws-token');
        if (resp.ok) {
          const data = await resp.json();
          wsUrl += `?token=${encodeURIComponent(data.token)}`;
        }
      } catch (e) {
        console.warn('Failed to get WS token:', e);
      }
    }

    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
      console.log('Connected to Nexus');
      wsReady = true;

      // Always reset send button on reconnect
      document.getElementById('sendBtn').disabled = false;
      isStreaming = false;
      currentStreamEl = null;
      document.getElementById('typing').classList.remove('visible');

      refreshStatus();
      loadConversationList();

      // Resume last conversation if we had one
      const savedId = getSavedConvId();
      if (savedId) {
        resumeConversation(savedId);
      }
    };

    ws.onmessage = (e) => {
      const data = JSON.parse(e.data);
      handleWsMessage(data);
    };

    ws.onclose = () => {
      console.log('Disconnected. Reconnecting in 2s...');
      wsReady = false;
      setTimeout(connect, 2000);
    };

    ws.onerror = (err) => {
      console.error('WebSocket error:', err);
    };
  }

  // Resume a saved conversation ‚Äî lightweight, doesn't call newChat on failure
  async function resumeConversation(convId) {
    try {
      const resp = await fetch(`/api/conversations/${convId}/messages`);
      if (!resp.ok) {
        // Stale conv_id in localStorage ‚Äî just clear it and start fresh
        console.warn('Saved conversation gone, clearing');
        saveConvId(null);
        return;
      }
      const data = await resp.json();

      // Tell backend
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'set_conversation', conv_id: convId }));
      }

      saveConvId(convId);
      document.getElementById('chatTitle').textContent = data.conversation?.title || 'Conversation';

      clearMessages();
      const messages = data.messages || [];
      if (messages.length > 0) {
        showWelcome(false);
        for (const m of messages) {
          const el = addMessage(m.content, m.role, m.model_used);
          if (m.role !== 'user') {
            el.querySelector('.msg-content').innerHTML = renderContent(m.content);
          }
        }
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
      }
      renderConversationList();
    } catch (e) {
      console.error('Resume failed:', e);
      saveConvId(null);
    }
  }

  function handleWsMessage(data) {
    const msgs = document.getElementById('messages');
    const typing = document.getElementById('typing');

    switch (data.type) {
      // ‚îÄ‚îÄ Conversation lifecycle ‚îÄ‚îÄ
      case 'conversation_set':
        saveConvId(data.conv_id);
        document.getElementById('chatTitle').textContent = data.title || 'New Conversation';
        loadConversationList();
        break;

      case 'conversation_renamed':
        document.getElementById('chatTitle').textContent = data.title;
        loadConversationList();
        break;

      // ‚îÄ‚îÄ Streaming ‚îÄ‚îÄ
      case 'stream_start':
        showWelcome(false);
        isStreaming = true;
        typing.classList.remove('visible');
        currentStreamEl = addMessage('', 'assistant', data.model);
        break;

      case 'stream_chunk':
        if (currentStreamEl) {
          currentStreamEl.querySelector('.msg-content').textContent += data.content;
          msgs.scrollTop = msgs.scrollHeight;
        }
        break;

      case 'stream_end':
        isStreaming = false;
        if (currentStreamEl) {
          const contentEl = currentStreamEl.querySelector('.msg-content');
          contentEl.innerHTML = renderContent(contentEl.textContent);
        }
        currentStreamEl = null;
        // Re-enable after a short delay ‚Äî if tool loop continues,
        // the next stream_start will keep it disabled
        setTimeout(() => {
          if (!isStreaming) {
            document.getElementById('sendBtn').disabled = false;
          }
        }, 200);
        break;

      case 'message':
        showWelcome(false);
        typing.classList.remove('visible');
        const el = addMessage(data.content, 'assistant', data.model);
        el.querySelector('.msg-content').innerHTML = renderContent(data.content);
        document.getElementById('sendBtn').disabled = false;
        break;

      case 'system':
        addMessage(data.content, 'system');
        break;

      case 'error':
        typing.classList.remove('visible');
        addMessage(data.content, 'system');
        document.getElementById('sendBtn').disabled = false;
        isStreaming = false;
        break;
    }
  }

  // ‚îÄ‚îÄ Conversation List ‚îÄ‚îÄ

  async function loadConversationList() {
    try {
      const resp = await fetch('/api/conversations');
      convListCache = await resp.json();
      renderConversationList();
    } catch (e) {
      console.error('Failed to load conversations:', e);
    }
  }

  function renderConversationList() {
    const container = document.getElementById('convList');
    if (!convListCache.length) {
      container.innerHTML = '<div style="padding:8px 12px;font-size:11px;color:var(--text-muted)">No conversations yet</div>';
      return;
    }
    container.innerHTML = convListCache.map(c => {
      const active = c.id === currentConvId ? ' active' : '';
      const title = escapeHtml(c.title || 'Untitled');
      return `<div class="conv-item${active}" onclick="switchConversation('${c.id}')" title="${title}">
        <span class="conv-title">${title}</span>
        <button class="conv-delete" onclick="event.stopPropagation();deleteConv('${c.id}')" title="Delete">√ó</button>
      </div>`;
    }).join('');
  }

  // ‚îÄ‚îÄ Switch / Resume Conversation ‚îÄ‚îÄ

  async function switchConversation(convId) {
    // Don't reload if already viewing this conv and messages are rendered
    if (convId === currentConvId) {
      const msgCount = document.querySelectorAll('.message-group').length;
      if (msgCount > 0) return;
    }

    // Load message history from REST API first to verify conv exists
    try {
      const resp = await fetch(`/api/conversations/${convId}/messages`);
      if (!resp.ok) {
        // Conversation was deleted or doesn't exist ‚Äî clear stale state
        console.warn('Conversation not found, starting fresh');
        saveConvId(null);
        newChat();
        return;
      }
      const data = await resp.json();

      // Now tell backend which conversation to use (after verifying it exists)
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'set_conversation', conv_id: convId }));
      }

      saveConvId(convId);
      document.getElementById('chatTitle').textContent = data.conversation?.title || 'Conversation';

      // Clear and render
      clearMessages();
      const messages = data.messages || [];
      if (messages.length > 0) {
        showWelcome(false);
        for (const m of messages) {
          const el = addMessage(m.content, m.role, m.model_used);
          if (m.role !== 'user') {
            el.querySelector('.msg-content').innerHTML = renderContent(m.content);
          }
        }
        // Scroll to bottom
        const msgEl = document.getElementById('messages');
        msgEl.scrollTop = msgEl.scrollHeight;
      } else {
        showWelcome(true);
      }

      renderConversationList();
    } catch (e) {
      console.error('Failed to load conversation:', e);
      saveConvId(null);
    }
  }

  // ‚îÄ‚îÄ New Chat ‚îÄ‚îÄ

  function newChat() {
    saveConvId(null);
    clearMessages();
    showWelcome(true);
    document.getElementById('chatTitle').textContent = 'Nexus';

    // Tell backend to create a fresh conversation (conv_id: null)
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'set_conversation', conv_id: null }));
    }

    renderConversationList();
    document.getElementById('input').focus();
  }

  // ‚îÄ‚îÄ Delete Conversation ‚îÄ‚îÄ

  async function deleteConv(convId) {
    if (!confirm('Delete this conversation?')) return;
    try {
      await fetch(`/api/conversations/${convId}`, { method: 'DELETE' });
      if (convId === currentConvId) {
        newChat();
      }
      await loadConversationList();
    } catch (e) {
      console.error('Failed to delete:', e);
    }
  }

  // ‚îÄ‚îÄ Clear Messages ‚îÄ‚îÄ

  function clearMessages() {
    const msgs = document.getElementById('messages');
    const typing = document.getElementById('typing');
    const welcome = document.getElementById('welcome');
    // Remove only message-group elements ‚Äî preserve welcome and typing
    const toRemove = [];
    for (const child of msgs.children) {
      if (child !== typing && child !== welcome) {
        toRemove.push(child);
      }
    }
    toRemove.forEach(el => el.remove());
  }

  function showWelcome(visible) {
    const el = document.getElementById('welcome');
    if (el) el.style.display = visible ? '' : 'none';
  }

  // ‚îÄ‚îÄ Message rendering ‚îÄ‚îÄ
  function addMessage(content, role, model) {
    const msgs = document.getElementById('messages');
    const typing = document.getElementById('typing');

    const group = document.createElement('div');
    group.className = 'message-group';

    const msg = document.createElement('div');
    msg.className = `message ${role}`;
    msg.innerHTML = `<span class="msg-content">${escapeHtml(content)}</span>`;
    group.appendChild(msg);

    if (model && role === 'assistant') {
      const meta = document.createElement('div');
      meta.className = 'message-meta assistant-meta';
      meta.innerHTML = `<span class="model-badge">${escapeHtml(model)}</span>`;
      group.appendChild(meta);
    }

    msgs.insertBefore(group, typing);
    msgs.scrollTop = msgs.scrollHeight;
    return msg;
  }

  function renderContent(text) {
    // Strip tool call tags (user shouldn't see raw XML)
    text = text.replace(/<tool_call>[\s\S]*?<\/tool_call>/g, '');
    text = text.replace(/<skill_action>[\s\S]*?<\/skill_action>/g, '');
    text = text.trim();

    // Simple markdown rendering
    let html = escapeHtml(text);
    // Code blocks
    html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
    // Inline code
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    // Bold
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    // Italic
    html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    // Line breaks
    html = html.replace(/\n/g, '<br>');
    return html;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ‚îÄ‚îÄ Send ‚îÄ‚îÄ
  function send() {
    const input = document.getElementById('input');
    const text = input.value.trim();
    if (!text) return;

    // Check WebSocket
    if (!ws || ws.readyState !== WebSocket.OPEN) {
      addMessage('‚ö† Not connected to server. Reconnecting...', 'system');
      return;
    }

    // Show user message
    showWelcome(false);
    addMessage(text, 'user');

    // Show typing
    if (!text.startsWith('/')) {
      document.getElementById('typing').classList.add('visible');
    }

    // Disable send
    document.getElementById('sendBtn').disabled = true;

    // Safety: re-enable after 30s if no response (prevents permanent lock)
    setTimeout(() => {
      if (document.getElementById('sendBtn').disabled) {
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('typing').classList.remove('visible');
        isStreaming = false;
      }
    }, 30000);

    // Send
    ws.send(JSON.stringify({ text }));

    // Reset input
    input.value = '';
    input.style.height = 'auto';
  }

  function sendQuick(text) {
    document.getElementById('input').value = text;
    send();
  }

  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  }

  function autoGrow(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  }

  // (newChat defined above in conversation management)

  // ‚îÄ‚îÄ Status ‚îÄ‚îÄ
  async function refreshStatus() {
    try {
      const resp = await fetch('/api/status');
      const data = await resp.json();
      document.getElementById('ollamaStatus').className =
        `status-dot ${data.models.ollama_available ? 'on' : 'off'}`;
      document.getElementById('claudeStatus').className =
        `status-dot ${data.models.claude_available ? 'on' : 'off'}`;
    } catch (e) {
      console.error('Failed to fetch status:', e);
    }
  }

  // ‚îÄ‚îÄ Panels ‚îÄ‚îÄ
  let openPanelId = null;

  function togglePanel(name) {
    const panel = document.getElementById(`${name}Panel`);
    const overlay = document.getElementById('panelOverlay');

    if (openPanelId === name) {
      closePanel();
      return;
    }

    closePanel();
    panel.classList.add('open');
    overlay.classList.add('visible');
    openPanelId = name;

    if (name === 'skills') loadSkills();
    if (name === 'tasks') loadTasks();
    if (name === 'docs') loadDocs();
    if (name === 'admin') loadAdmin();
  }

  function closePanel() {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('open'));
    document.getElementById('panelOverlay').classList.remove('visible');
    openPanelId = null;
  }

  async function loadSkills() {
    try {
      const resp = await fetch('/api/skills');
      const skills = await resp.json();
      const el = document.getElementById('skillsList');

      if (!skills.length) {
        el.innerHTML = '<p style="color:var(--text-muted);font-size:13px;">No skills learned yet. Use <code>/learn &lt;topic&gt;</code> to get started.</p>';
        return;
      }

      el.innerHTML = skills.map(s => `
        <div class="skill-card">
          <h4>${escapeHtml(s.name)}</h4>
          <p>${escapeHtml(s.description || '')}</p>
          <div class="skill-meta">
            <span>${escapeHtml(s.domain || 'general')} ¬∑ Used ${s.usage_count || 0} times</span>
            <button class="skill-delete" onclick="deleteSkill('${s.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    } catch (e) {
      console.error('Failed to load skills:', e);
    }
  }

  async function loadTasks() {
    try {
      const resp = await fetch('/api/tasks');
      const tasks = await resp.json();
      const el = document.getElementById('tasksList');

      if (!tasks.length) {
        el.innerHTML = '<p style="color:var(--text-muted);font-size:13px;">No tasks yet.</p>';
        return;
      }

      const emoji = { pending: '‚è≥', running: 'üîÑ', completed: '‚úÖ', failed: '‚ùå', cancelled: 'üö´' };
      el.innerHTML = tasks.map(t => `
        <div class="skill-card">
          <h4>${emoji[t.status] || '‚ùì'} ${escapeHtml(t.type)}</h4>
          <p>Status: ${t.status}</p>
          <div class="skill-meta">
            <span>${t.id}</span>
          </div>
        </div>
      `).join('');
    } catch (e) {
      console.error('Failed to load tasks:', e);
    }
  }

  async function deleteSkill(id) {
    if (!confirm('Delete this skill?')) return;
    await fetch(`/api/skills/${id}`, { method: 'DELETE' });
    loadSkills();
  }

  async function loadDocs() {
    try {
      const resp = await fetch('/api/docs');
      const data = await resp.json();
      const el = document.getElementById('docsList');
      document.getElementById('docsDir').textContent = `Path: ${data.docs_dir}`;

      if (!data.files || !data.files.length) {
        el.innerHTML = `<p style="color:var(--text-muted);font-size:13px;">No documents found.<br><br>Place files in:<br><code>${escapeHtml(data.docs_dir)}</code></p>`;
        return;
      }

      el.innerHTML = data.files.map(f => {
        const sizeKB = (f.size / 1024).toFixed(0);
        return `
          <div class="skill-card">
            <h4>${escapeHtml(f.name)}</h4>
            <p>${escapeHtml(f.relative_path)} ¬∑ ${sizeKB}KB</p>
            <div class="skill-meta">
              <span>${f.extension}</span>
              <button class="skill-delete" style="color:var(--accent);opacity:1" onclick="ingestFile('${escapeHtml(f.name)}')">üì• Ingest</button>
            </div>
          </div>
        `;
      }).join('');
    } catch (e) {
      console.error('Failed to load docs:', e);
    }
  }

  async function ingestFile(filename) {
    try {
      const resp = await fetch(`/api/docs/ingest/${encodeURIComponent(filename)}`, { method: 'POST' });
      const data = await resp.json();
      addMessage(`üì• Ingesting ${filename}... Task: ${data.task.id}`, 'system');
      showWelcome(false);
    } catch (e) {
      addMessage(`‚ùå Failed to ingest: ${e.message}`, 'system');
    }
  }

  async function ingestAll() {
    if (!confirm('Ingest all documents? This will use your Claude API credits.')) return;
    try {
      const resp = await fetch('/api/docs/ingest-all', { method: 'POST' });
      const data = await resp.json();
      closePanel();
      addMessage(`üì• Queued ${data.queued} documents for ingestion.`, 'system');
      showWelcome(false);
    } catch (e) {
      addMessage(`‚ùå Failed: ${e.message}`, 'system');
    }
  }

  // ‚îÄ‚îÄ Admin Panel ‚îÄ‚îÄ
  function loadAdmin() {
    loadAdminSettings();
    loadAdminPlugins();
    loadAdminPersona();
    loadAdminSystem();
  }

  function switchAdminTab(tabName, btn) {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
    btn.classList.add('active');
    const sectionMap = { settings: 'adminSettings', plugins: 'adminPlugins', persona: 'adminPersona', system: 'adminSystem' };
    document.getElementById(sectionMap[tabName]).classList.add('active');
  }

  function showToast(message, type) {
    const t = document.createElement('div');
    t.className = `admin-toast ${type || 'info'}`;
    t.textContent = message;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3500);
  }

  // -- Settings --
  let currentSettings = [];

  async function loadAdminSettings() {
    try {
      const resp = await fetch('/api/admin/settings');
      const data = await resp.json();
      currentSettings = data.settings;
      renderSettings(data.settings);
    } catch (e) {
      document.getElementById('settingsForm').innerHTML = '<p style="color:var(--error);">Failed to load settings.</p>';
    }
  }

  function renderSettings(settings) {
    const groups = {};
    settings.forEach(s => {
      if (!groups[s.section]) groups[s.section] = [];
      groups[s.section].push(s);
    });

    let html = '';
    for (const [section, fields] of Object.entries(groups)) {
      html += `<div class="admin-group"><div class="admin-group-title">${escapeHtml(section)}</div>`;
      for (const f of fields) {
        html += `<div class="admin-field"><label>${escapeHtml(f.label)}</label>`;
        html += `<div class="field-desc">${escapeHtml(f.description || '')}</div>`;

        if (f.type === 'select') {
          html += `<select id="setting_${f.key}" data-key="${f.key}">`;
          for (const opt of (f.options || [])) {
            const sel = f.value === opt ? 'selected' : '';
            html += `<option value="${escapeHtml(opt)}" ${sel}>${escapeHtml(opt)}</option>`;
          }
          html += `</select>`;
        } else if (f.type === 'range') {
          html += `<div class="range-value" id="rangeVal_${f.key}">${escapeHtml(f.value || String(f.min || 0))}</div>`;
          html += `<input type="range" id="setting_${f.key}" data-key="${f.key}" min="${f.min || 0}" max="${f.max || 100}" value="${escapeHtml(f.value || String(f.min || 0))}" oninput="document.getElementById('rangeVal_${f.key}').textContent=this.value">`;
          html += `<div class="range-labels"><span>${f.min || 0} (always Claude)</span><span>${f.max || 100} (always local)</span></div>`;
        } else if (f.type === 'password') {
          const placeholder = f.has_value ? 'Value set (enter new to change)' : 'Not set';
          html += `<input type="password" id="setting_${f.key}" data-key="${f.key}" placeholder="${placeholder}" value="">`;
        } else if (f.type === 'number') {
          html += `<input type="number" id="setting_${f.key}" data-key="${f.key}" min="${f.min || ''}" max="${f.max || ''}" value="${escapeHtml(f.value || '')}">`;
        } else {
          html += `<input type="text" id="setting_${f.key}" data-key="${f.key}" value="${escapeHtml(f.value || '')}">`;
        }
        html += `</div>`;
      }
      html += `</div>`;
    }
    document.getElementById('settingsForm').innerHTML = html;
  }

  async function saveSettings() {
    const updates = {};
    document.querySelectorAll('[data-key]').forEach(el => {
      const key = el.dataset.key;
      const val = el.value;
      // Only include non-empty values (skip empty passwords)
      const schema = currentSettings.find(s => s.key === key);
      if (schema && schema.type === 'password') {
        if (val) updates[key] = val; // only update if user typed something
      } else if (val !== '') {
        updates[key] = val;
      }
    });

    if (!Object.keys(updates).length) {
      showToast('No changes to save', 'info');
      return;
    }

    try {
      const resp = await fetch('/api/admin/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ updates }),
      });
      const data = await resp.json();
      showToast(data.message, 'success');
    } catch (e) {
      showToast('Failed to save settings', 'error');
    }
  }

  // -- Plugins --
  async function loadAdminPlugins() {
    try {
      const resp = await fetch('/api/admin/plugins');
      const data = await resp.json();
      const el = document.getElementById('pluginsList');
      let html = '';

      if (data.active.length === 0 && data.available.length === 0) {
        html = '<p style="color:var(--text-muted);font-size:13px;">No plugins found.</p>';
      }

      for (const p of data.active) {
        html += `<div class="plugin-card">
          <div class="plugin-card-header">
            <h4>üîå ${escapeHtml(p.name)}</h4>
            <span class="plugin-badge active">Active</span>
          </div>
          <p style="font-size:12px;color:var(--text-secondary);">${escapeHtml(p.description)}</p>
          <p style="font-size:10px;color:var(--text-muted);margin-top:4px;">v${escapeHtml(p.version)} ¬∑ ${p.tools.length} tools ¬∑ ${p.commands.length} commands</p>`;
        if (p.tools.length) {
          html += `<div class="plugin-tools-list">`;
          for (const t of p.tools) {
            html += `<div>‚Ä¢ <strong>${escapeHtml(t.name)}</strong> ‚Äî ${escapeHtml(t.description)}</div>`;
          }
          html += `</div>`;
        }
        if (p.commands.length) {
          html += `<div style="margin-top:6px;font-size:11px;color:var(--text-muted);">Commands: ${p.commands.map(c => '<code>' + escapeHtml(c.command) + '</code>').join(', ')}</div>`;
        }
        html += `</div>`;
      }

      for (const p of data.available) {
        html += `<div class="plugin-card" style="opacity:0.6;">
          <div class="plugin-card-header">
            <h4>üì¶ ${escapeHtml(p.name)}</h4>
            <span class="plugin-badge inactive">Inactive</span>
          </div>
          <p style="font-size:11px;color:var(--text-muted);">${escapeHtml(p.reason)}</p>
          <p style="font-size:10px;color:var(--text-muted);margin-top:4px;">File: ${escapeHtml(p.file)}</p>
        </div>`;
      }

      el.innerHTML = html;
    } catch (e) {
      document.getElementById('pluginsList').innerHTML = '<p style="color:var(--error);">Failed to load plugins.</p>';
    }
  }

  async function testModel(model) {
    showToast(`Testing ${model}...`, 'info');
    try {
      const resp = await fetch('/api/admin/test-model', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model }),
      });
      const data = await resp.json();
      if (data.success) {
        showToast(`${model} OK: "${data.response}"`, 'success');
      } else {
        showToast(`${model} failed: ${data.error}`, 'error');
      }
    } catch (e) {
      showToast(`Test failed: ${e.message}`, 'error');
    }
  }

  // -- Persona --
  async function loadAdminPersona() {
    try {
      const resp = await fetch('/api/admin/system-prompt');
      const data = await resp.json();
      document.getElementById('systemPromptPreview').textContent = data.full_prompt || data.base_prompt;
    } catch (e) {}

    try {
      const resp = await fetch('/api/admin/settings');
      const data = await resp.json();
      const nameField = data.settings.find(s => s.key === 'AGENT_NAME');
      if (nameField && nameField.value) document.getElementById('personaName').value = nameField.value;
      const instrField = data.settings.find(s => s.key === 'CUSTOM_SYSTEM_PROMPT');
      if (instrField && instrField.value) document.getElementById('personaInstructions').value = instrField.value.replace(/\\n/g, '\n');
    } catch (e) {}
  }

  async function savePersona() {
    const name = document.getElementById('personaName').value.trim();
    const instructions = document.getElementById('personaInstructions').value.trim();
    const updates = {};
    if (name) updates['AGENT_NAME'] = name;
    if (instructions) updates['CUSTOM_SYSTEM_PROMPT'] = instructions.replace(/\n/g, '\\n');

    try {
      const resp = await fetch('/api/admin/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ updates }),
      });
      const data = await resp.json();
      showToast('Persona saved. Restart to apply.', 'success');
    } catch (e) {
      showToast('Failed to save persona', 'error');
    }
  }

  // -- System --
  async function loadAdminSystem() {
    try {
      const resp = await fetch('/api/admin/system');
      const data = await resp.json();
      document.getElementById('systemInfo').innerHTML =
        `Python: ${escapeHtml(data.python_version.split(' ')[0])}<br>` +
        `Platform: ${escapeHtml(data.platform)}<br>` +
        `Base dir: <code>${escapeHtml(data.base_dir)}</code><br>` +
        `Skills: <code>${escapeHtml(data.skills_dir)}</code><br>` +
        `Documents: <code>${escapeHtml(data.docs_dir)}</code><br>` +
        `Data: <code>${escapeHtml(data.data_dir)}</code><br>` +
        `.env: ${data.env_exists ? '‚úÖ' : '‚ùå'} <code>${escapeHtml(data.env_path)}</code>`;
    } catch (e) {}

    try {
      const resp = await fetch('/api/admin/restart-hint', { method: 'POST' });
      const data = await resp.json();
      document.getElementById('restartCommands').innerHTML =
        data.commands.map(c => `$ ${escapeHtml(c)}`).join('<br>');
    } catch (e) {}
  }

  async function clearConversations() {
    if (!confirm('Delete all conversation history? This cannot be undone.')) return;
    try {
      const resp = await fetch('/api/conversations');
      const convs = await resp.json();
      for (const c of convs) {
        await fetch(`/api/conversations/${c.id}`, { method: 'DELETE' });
      }
      showToast(`Cleared ${convs.length} conversations`, 'success');
      newChat();
      await loadConversationList();
    } catch (e) {
      showToast('Failed to clear history', 'error');
    }
  }

  // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ
  let authEnabled = false;
  let currentUser = null;
  let refreshTimer = null;

  async function checkAuth() {
    try {
      const resp = await fetch('/api/auth/status');
      const status = await resp.json();
      authEnabled = status.auth_enabled;

      if (!authEnabled) {
        document.getElementById('loginOverlay').classList.add('hidden');
        return true;
      }

      // Check for auth errors in URL
      const params = new URLSearchParams(window.location.search);
      const authError = params.get('auth_error');
      if (authError) {
        const errorEl = document.getElementById('loginError');
        const messages = {
          exchange_failed: 'Sign-in failed. Please try again.',
          not_whitelisted: 'Your email is not on the access list.',
          account_disabled: 'Your account has been deactivated.',
          ip_blocked: 'Too many failed attempts. Please try later.',
          missing_params: 'Invalid callback. Please try again.',
        };
        errorEl.textContent = messages[authError] || 'Authentication error.';
        errorEl.classList.add('visible');
        // Clean URL
        history.replaceState(null, '', '/');
      }

      // Try to get current user
      const meResp = await fetch('/api/auth/me');
      if (!meResp.ok) {
        document.getElementById('loginOverlay').classList.remove('hidden');
        return false;
      }

      currentUser = await meResp.json();
      document.getElementById('loginOverlay').classList.add('hidden');
      showUserInfo(currentUser);
      scheduleTokenRefresh();
      return true;
    } catch (e) {
      console.error('Auth check failed:', e);
      return true; // Allow access on error (fail-open for UX)
    }
  }

  function showUserInfo(user) {
    const el = document.getElementById('userInfo');
    el.classList.remove('hidden');
    document.getElementById('userName').textContent = user.name || user.email;
    document.getElementById('userRole').textContent = user.role || 'user';
    const avatar = document.getElementById('userAvatar');
    if (user.picture) {
      avatar.innerHTML = `<img src="${escapeHtml(user.picture)}" alt="">`;
    } else {
      avatar.textContent = (user.name || user.email || '?').charAt(0).toUpperCase();
    }
  }

  function scheduleTokenRefresh() {
    if (refreshTimer) clearTimeout(refreshTimer);
    // Refresh 2 minutes before expiry (default 30 min access token -> refresh at 28 min)
    const refreshIn = 28 * 60 * 1000;
    refreshTimer = setTimeout(async () => {
      try {
        const resp = await fetch('/api/auth/refresh', { method: 'POST' });
        if (resp.ok) {
          scheduleTokenRefresh();
        } else {
          // Refresh failed ‚Äî force re-login
          window.location.href = '/api/auth/login';
        }
      } catch (e) {
        console.error('Token refresh failed:', e);
      }
    }, refreshIn);
  }

  async function signOut() {
    try {
      await fetch('/api/auth/logout', { method: 'POST' });
    } catch (e) {}
    if (refreshTimer) clearTimeout(refreshTimer);
    currentUser = null;
    document.getElementById('userInfo').classList.add('hidden');
    window.location.reload();
  }

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  // Validate auth, then saved conversation, then connect
  (async () => {
    const authed = await checkAuth();
    if (!authed) return; // Login overlay is showing

    const savedId = getSavedConvId();
    if (savedId) {
      try {
        const resp = await fetch(`/api/conversations/${savedId}/messages`);
        if (!resp.ok) {
          console.warn('Startup: stale conv_id in localStorage, clearing');
          saveConvId(null);
        }
      } catch(e) {
        saveConvId(null);
      }
    }
    connect();
  })();
  setInterval(refreshStatus, 30000);
</script>
</body>
</html>
